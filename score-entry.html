<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Score Entry System</title>
    
    <!-- Firebase SDKs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-auth-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-firestore-compat.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 1.5rem;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .score-sheet-container {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .trial-selector {
            margin-bottom: 2rem;
        }

        .trial-selector select {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
        }

        .round-selector {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .round-card {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 200px;
        }

        .round-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .round-card.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .round-info {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .judge-info {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .score-sheet {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 1.5rem;
            margin-top: 2rem;
        }

        .sheet-header {
            text-align: center;
            margin-bottom: 2rem;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 1rem;
        }

        .sheet-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 1rem;
        }

        .sheet-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .scent-locations {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
        }

        .scent-location {
            text-align: center;
        }

        .scent-location label {
            font-weight: 600;
            display: block;
            margin-bottom: 0.5rem;
        }

        .scent-location input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }

        .scoring-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 2rem;
        }

        .scoring-table th,
        .scoring-table td {
            border: 1px solid #dee2e6;
            padding: 0.5rem;
            text-align: center;
        }

        .scoring-table th {
            background: #f8f9fa;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .team-name {
            text-align: left !important;
            font-weight: 600;
            background: #f0f8ff;
        }

        .scent-cell {
            width: 60px;
        }

        .scent-cell select {
            width: 100%;
            padding: 0.25rem;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }

        .fault-cell {
            width: 80px;
        }

        .fault-cell input {
            width: 100%;
            padding: 0.25rem;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }

        .time-cell {
            width: 70px;
        }

        .time-cell input {
            width: 100%;
            padding: 0.25rem;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }

        .passfail-cell {
            width: 80px;
        }

        .passfail-cell select {
            width: 100%;
            padding: 0.25rem;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }

        .btn {
            padding: 0.8rem 1.5rem;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            margin: 0.25rem;
            text-decoration: none;
            display: inline-block;
        }

        .btn:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #28a745;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .control-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }

        .status-message {
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 8px;
            display: none;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-info {
            background: #cce7ff;
            color: #0056b3;
            border: 1px solid #99d3ff;
        }

        .no-data {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 3rem;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .auto-calculate {
            background: #e8f5e8;
            border-left: 4px solid #28a745;
            padding: 0.5rem;
            margin: 0.25rem 0;
            font-size: 0.8rem;
        }

        @media (max-width: 768px) {
            .scoring-table {
                font-size: 0.8rem;
            }
            
            .scent-locations {
                grid-template-columns: repeat(2, 1fr);
            }

            .control-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div>
                <h1>üìä Score Entry System</h1>
                <p>Enter trial results into digital score sheets</p>
            </div>
            <div>
                <a href="trial-secretary-dashboard.html" class="btn btn-secondary">‚Üê Back to Dashboard</a>
            </div>
        </div>

        <!-- Status Message -->
        <div class="status-message" id="statusMessage"></div>

        <!-- Score Sheet Container -->
        <div class="score-sheet-container">
            <!-- Trial Selector -->
            <div class="trial-selector">
                <label for="trialSelect"><strong>Select Trial:</strong></label>
                <select id="trialSelect" onchange="loadTrialRounds()">
                    <option value="">Loading trials...</option>
                </select>
            </div>

            <!-- Round Selector -->
            <div class="round-selector" id="roundSelector" style="display: none;">
                <!-- Round cards will be generated here -->
            </div>

            <!-- Score Sheet -->
            <div class="score-sheet" id="scoreSheet" style="display: none;">
                <!-- Score sheet header -->
                <div class="sheet-header">
                    <div class="sheet-title">Scent Detective Master Score Sheet</div>
                    <div class="sheet-info">
                        <div><strong>Class:</strong> <span id="sheetClass">-</span></div>
                        <div><strong>Date:</strong> <span id="sheetDate">-</span></div>
                        <div><strong>Judge:</strong> <span id="sheetJudge">-</span></div>
                    </div>
                </div>

                <!-- Scent Locations -->
                <div class="scent-locations">
                    <div class="scent-location">
                        <label>Scent 1 Located in/on:</label>
                        <input type="text" id="scent1Location" placeholder="Enter location">
                    </div>
                    <div class="scent-location">
                        <label>Scent 2 Located in/on:</label>
                        <input type="text" id="scent2Location" placeholder="Enter location">
                    </div>
                    <div class="scent-location">
                        <label>Scent 3 Located in/on:</label>
                        <input type="text" id="scent3Location" placeholder="Enter location">
                    </div>
                    <div class="scent-location">
                        <label>Scent 4 Located in/on:</label>
                        <input type="text" id="scent4Location" placeholder="Enter location">
                    </div>
                </div>

                <!-- Scoring Table -->
                <table class="scoring-table" id="scoringTable">
                    <thead>
                        <tr>
                            <th>Team Dog - Handler</th>
                            <th>Scent 1</th>
                            <th>Scent 2</th>
                            <th>Scent 3</th>
                            <th>Scent 4</th>
                            <th>Fault</th>
                            <th>Fault</th>
                            <th>Time</th>
                            <th>Pass/Fail</th>
                        </tr>
                    </thead>
                    <tbody id="scoringTableBody">
                        <!-- Scoring rows will be generated here -->
                    </tbody>
                </table>

                <!-- Control Buttons -->
                <div class="control-buttons">
                    <button class="btn btn-success" onclick="saveScores()">üíæ Save Scores</button>
                    <button class="btn btn-warning" onclick="exportFilledScoreSheet()">üìÑ Export Filled PDF</button>
                    <button class="btn btn-secondary" onclick="clearAllScores()">üóëÔ∏è Clear All Scores</button>
                </div>

                <div class="auto-calculate">
                    üí° <strong>Auto-calculation:</strong> Pass/Fail will automatically update based on scent finds and faults
                </div>
            </div>

            <!-- No Data Message -->
            <div class="no-data" id="noDataMessage" style="display: none;">
                <h3>üìã No Score Sheets Available</h3>
                <p>Please select a trial that has running orders configured.</p>
                <p>Go to Running Order Management to set up your trial first.</p>
            </div>
        </div>
    </div>

    <script>
        // C-WAGS Standard Class Order
const CWAGS_CLASS_ORDER = [
    'Patrol 1', 'Detective 2', 'Investigator 3', 'Super Sleuth 4', 'Private Inv', 'Det Diversions',
    'Ranger 1', 'Ranger 2', 'Ranger 3', 'Ranger 4', 'Ranger 5',
    'Dasher 3', 'Dasher 4', 'Dasher 5', 'Dasher 6',
    'Obedience 1', 'Obedience 2', 'Obedience 3', 'Obedience 4', 'Obedience 5',
    'Starter', 'Advanced', 'Pro', 'ARF',
    'Zoom 1', 'Zoom 1.5', 'Zoom 2',
    'Games 1', 'Games 2', 'Games 3', 'Games 4'
];
        
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBWpyM_lEpqdQWuKuLLZiW1SlloWsWkJCs",
            authDomain: "dog-trialing-system.firebaseapp.com",
            projectId: "dog-trialing-system",
            storageBucket: "dog-trialing-system.firebasestorage.app",
            messagingSenderId: "490812593982",
            appId: "1:490812593982:web:344776707566f8d9027e6f",
            measurementId: "G-EMLX58Y278"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Global variables
        let currentUser = null;
        let currentTrial = null;
        let currentRound = null;
        let allRounds = [];
        let currentScores = {};

        // Utility functions
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status-message status-${type}`;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        function createLocalDate(dateStr) {
            if (!dateStr) return null;
            if (typeof dateStr === 'string') {
                const dateWithTime = dateStr.includes('T') ? dateStr : dateStr + 'T12:00:00';
                return new Date(dateWithTime);
            }
            return new Date(dateStr);
        }

        function formatLocalDate(date) {
            if (!date || !(date instanceof Date)) return '';
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function getDateFromFirebase(firebaseDate) {
            if (!firebaseDate) return '';
            let date;
            if (firebaseDate.toDate) {
                date = firebaseDate.toDate();
            } else if (firebaseDate instanceof Date) {
                date = firebaseDate;
            } else if (typeof firebaseDate === 'string') {
                date = createLocalDate(firebaseDate);
            } else {
                return '';
            }
            return formatLocalDate(date);
        }

        // Initialize the application
        async function init() {
            try {
                await new Promise((resolve, reject) => {
                    const unsubscribe = auth.onAuthStateChanged(async (user) => {
                        unsubscribe();
                        if (user) {
                            try {
                                const userDoc = await db.collection('users').doc(user.uid).get();
                                if (userDoc.exists) {
                                    currentUser = { uid: user.uid, ...userDoc.data() };
                                    resolve();
                                } else {
                                    reject(new Error('User profile not found'));
                                }
                            } catch (error) {
                                reject(error);
                            }
                        } else {
                            window.location.href = 'index.html';
                        }
                    });
                });

                await loadTrials();
            } catch (error) {
                console.error('Error initializing:', error);
                showStatus('Error initializing application: ' + error.message, 'error');
            }
        }

        // Load trials for the dropdown
        async function loadTrials() {
            try {
                showStatus('Loading your trials...', 'info');

                const trialsSnapshot = await db.collection("trials")
                    .where("createdBy", "==", currentUser.uid)
                    .get();

                const trialSelect = document.getElementById('trialSelect');
                trialSelect.innerHTML = '<option value="">Select a trial...</option>';

                if (!trialsSnapshot.empty) {
                    const trials = [];
                    trialsSnapshot.forEach(doc => {
                        trials.push({ id: doc.id, ...doc.data() });
                    });

                    trials.sort((a, b) => {
                        const aTime = a.createdAt ? a.createdAt.seconds : 0;
                        const bTime = b.createdAt ? b.createdAt.seconds : 0;
                        return bTime - aTime;
                    });

                    trials.forEach(trial => {
                        const option = document.createElement('option');
                        option.value = trial.id;
                        option.textContent = trial.clubName || 'Unnamed Trial';
                        trialSelect.appendChild(option);
                    });

                    showStatus(`Found ${trials.length} trials`, 'success');
                } else {
                    showStatus('No trials found', 'error');
                }
            } catch (error) {
                console.error('Error loading trials:', error);
                showStatus('Error loading trials: ' + error.message, 'error');
            }
        }

        // Load rounds for selected trial
        async function loadTrialRounds() {
            const trialId = document.getElementById('trialSelect').value;
            
            if (!trialId) {
                document.getElementById('roundSelector').style.display = 'none';
                document.getElementById('scoreSheet').style.display = 'none';
                document.getElementById('noDataMessage').style.display = 'none';
                return;
            }

            try {
                showStatus('Loading trial rounds...', 'info');

                // Load trial data
                const trialDoc = await db.collection('trials').doc(trialId).get();
                if (!trialDoc.exists) {
                    throw new Error('Trial not found');
                }

                currentTrial = { id: trialDoc.id, ...trialDoc.data() };

                // Fix date handling for trial days
                if (currentTrial.days && Array.isArray(currentTrial.days)) {
                    currentTrial.days = currentTrial.days.map(day => ({
                        ...day,
                        date: day.date ? getDateFromFirebase(day.date) : null
                    }));
                }

                // Load running order
                const orderDoc = await db.collection('running_orders').doc(trialId).get();
                if (!orderDoc.exists) {
                    throw new Error('No running order found for this trial');
                }

                const runningOrderData = orderDoc.data();
                allRounds = [];

                // Process rounds
                Object.keys(runningOrderData.roundOrders || {}).forEach(roundKey => {
                    const [dayIndex, classIndex, roundIndex] = roundKey.split('-').map(Number);
                    const day = currentTrial.days[dayIndex];
                    const cls = day?.classes[classIndex];
                    const round = cls?.rounds[roundIndex];

                    if (day && cls && round && runningOrderData.roundOrders[roundKey].length > 0) {
                        allRounds.push({
                            key: roundKey,
                            dayIndex,
                            classIndex,
                            roundIndex,
                            className: cls.className || cls.class || cls.CLASS_NAME || `Class ${classIndex + 1}`,
                            judgeName: round.judgeName || round.judge || round.JUDGE_NAME || 'Judge TBD',
                            roundNumber: roundIndex + 1,
                            date: day.date,
                            entryIds: runningOrderData.roundOrders[roundKey]
                        });
                    }
                });

                if (allRounds.length === 0) {
                    document.getElementById('noDataMessage').style.display = 'block';
                    document.getElementById('roundSelector').style.display = 'none';
                    showStatus('No rounds with entries found', 'error');
                    return;
                }

                renderRoundSelector();
                showStatus(`Found ${allRounds.length} rounds`, 'success');

            } catch (error) {
                console.error('Error loading trial rounds:', error);
                showStatus('Error loading rounds: ' + error.message, 'error');
                document.getElementById('noDataMessage').style.display = 'block';
            }
        }

        // Sort rounds: Date first ‚Üí Class order ‚Üí Round number
const sortedRounds = allRounds.sort((a, b) => {
    // Date first
    const dateA = new Date(a.date || '1900-01-01');
    const dateB = new Date(b.date || '1900-01-01');
    if (dateA.getTime() !== dateB.getTime()) {
        return dateA - dateB;
    }
    
    // Then class order
    const classIndexA = CWAGS_CLASS_ORDER.indexOf(a.className);
    const classIndexB = CWAGS_CLASS_ORDER.indexOf(b.className);
    if (classIndexA !== classIndexB) {
        return (classIndexA === -1 ? 999 : classIndexA) - (classIndexB === -1 ? 999 : classIndexB);
    }
    
    // Finally round number
    return a.roundNumber - b.roundNumber;
});

        // Select a round for scoring
        async function selectRound(round) {
            try {
                showStatus('Loading round data...', 'info');

                // Update active card
                document.querySelectorAll('.round-card').forEach(card => card.classList.remove('active'));
                event.target.closest('.round-card').classList.add('active');

                currentRound = round;

                // Load entries for this round
                const entriesSnapshot = await db.collection('entries')
                    .where('trialId', '==', currentTrial.id)
                    .get();

                const entryMap = {};
                entriesSnapshot.forEach(doc => {
                    entryMap[doc.id] = doc.data();
                });

                // Build participant list in running order
                const participants = [];
                round.entryIds.forEach(entryId => {
                    const [docId] = entryId.split('_');
                    const entry = entryMap[docId];
                    if (entry) {
                        participants.push({
                            id: entryId,
                            handlerName: entry.handlerName.split(' ')[0],
                            dogCallName: entry.dogCallName
                        });
                    }
                });

                // Load existing scores if any
                try {
                    const scoresDoc = await db.collection('scores').doc(`${currentTrial.id}_${round.key}`).get();
                    if (scoresDoc.exists) {
                        currentScores = scoresDoc.data();
                    } else {
                        currentScores = {};
                    }
                } catch (error) {
                    currentScores = {};
                }

                renderScoreSheet(round, participants);
                showStatus('Round loaded successfully', 'success');

            } catch (error) {
                console.error('Error selecting round:', error);
                showStatus('Error loading round: ' + error.message, 'error');
            }
        }

        // Render the score sheet
        function renderScoreSheet(round, participants) {
            // Update header info
            document.getElementById('sheetClass').textContent = round.className;
            document.getElementById('sheetDate').textContent = round.date ? createLocalDate(round.date).toLocaleDateString() : 'Date TBD';
            document.getElementById('sheetJudge').textContent = round.judgeName;

            // Load scent locations
            document.getElementById('scent1Location').value = currentScores.scent1Location || '';
            document.getElementById('scent2Location').value = currentScores.scent2Location || '';
            document.getElementById('scent3Location').value = currentScores.scent3Location || '';
            document.getElementById('scent4Location').value = currentScores.scent4Location || '';

            // Generate scoring table
            const tbody = document.getElementById('scoringTableBody');
            tbody.innerHTML = '';

            participants.forEach((participant, index) => {
                const row = document.createElement('tr');
                const participantScores = currentScores.participants?.[participant.id] || {};
                
                row.innerHTML = `
                    <td class="team-name">${participant.handlerName} - ${participant.dogCallName}</td>
                    <td class="scent-cell">
                        <select onchange="updateScore('${participant.id}', 'scent1', this.value)">
                            <option value="">-</option>
                            <option value="‚úì" ${participantScores.scent1 === '‚úì' ? 'selected' : ''}>‚úì</option>
                            <option value="X" ${participantScores.scent1 === 'X' ? 'selected' : ''}>X</option>
                        </select>
                    </td>
                    <td class="scent-cell">
                        <select onchange="updateScore('${participant.id}', 'scent2', this.value)">
                            <option value="">-</option>
                            <option value="‚úì" ${participantScores.scent2 === '‚úì' ? 'selected' : ''}>‚úì</option>
                            <option value="X" ${participantScores.scent2 === 'X' ? 'selected' : ''}>X</option>
                        </select>
                    </td>
                    <td class="scent-cell">
                        <select onchange="updateScore('${participant.id}', 'scent3', this.value)">
                            <option value="">-</option>
                            <option value="‚úì" ${participantScores.scent3 === '‚úì' ? 'selected' : ''}>‚úì</option>
                            <option value="X" ${participantScores.scent3 === 'X' ? 'selected' : ''}>X</option>
                        </select>
                    </td>
                    <td class="scent-cell">
                        <select onchange="updateScore('${participant.id}', 'scent4', this.value)">
                            <option value="">-</option>
                            <option value="‚úì" ${participantScores.scent4 === '‚úì' ? 'selected' : ''}>‚úì</option>
                            <option value="X" ${participantScores.scent4 === 'X' ? 'selected' : ''}>X</option>
                        </select>
                    </td>
                    <td class="fault-cell">
                        <input type="text" value="${participantScores.fault1 || ''}" 
                               onchange="updateScore('${participant.id}', 'fault1', this.value)"
                               placeholder="Fault">
                    </td>
                    <td class="fault-cell">
                        <input type="text" value="${participantScores.fault2 || ''}" 
                               onchange="updateScore('${participant.id}', 'fault2', this.value)"
                               placeholder="Fault">
                    </td>
                    <td class="time-cell">
                        <input type="text" value="${participantScores.time || ''}" 
                               onchange="updateScore('${participant.id}', 'time', this.value)"
                               placeholder="0:00">
                    </td>
                    <td class="passfail-cell">
                        <select onchange="updateScore('${participant.id}', 'passFail', this.value)">
                            <option value="">-</option>
                            <option value="Pass" ${participantScores.passFail === 'Pass' ? 'selected' : ''}>Pass</option>
                            <option value="Fail" ${participantScores.passFail === 'Fail' ? 'selected' : ''}>Fail</option>
                        </select>
                    </td>
                `;
                
                tbody.appendChild(row);
            });

            document.getElementById('scoreSheet').style.display = 'block';
            document.getElementById('noDataMessage').style.display = 'none';
        }

        // Update individual score
        function updateScore(participantId, field, value) {
            if (!currentScores.participants) {
                currentScores.participants = {};
            }
            if (!currentScores.participants[participantId]) {
                currentScores.participants[participantId] = {};
            }
            
            currentScores.participants[participantId][field] = value;

            // Auto-calculate pass/fail for scent fields
            if (field.startsWith('scent')) {
                autoCalculatePassFail(participantId);
            }
        }

        // Auto-calculate pass/fail based on scent results
        function autoCalculatePassFail(participantId) {
            const scores = currentScores.participants[participantId];
            if (!scores) return;

            const scents = [scores.scent1, scores.scent2, scores.scent3, scores.scent4];
            const foundScents = scents.filter(s => s === '‚úì').length;
            const hasFaults = scores.fault1 || scores.fault2;

            // Auto-suggest Pass/Fail (user can still override)
            let suggestion = '';
            if (foundScents >= 3 && !hasFaults) {
                suggestion = 'Pass';
            } else if (foundScents < 3 || hasFaults) {
                suggestion = 'Fail';
            }

            if (suggestion && !scores.passFail) {
                scores.passFail = suggestion;
                // Update the dropdown
                const passfailSelect = document.querySelector(`select[onchange*="${participantId}"][onchange*="passFail"]`);
                if (passfailSelect) {
                    passfailSelect.value = suggestion;
                }
            }
        }

        // Update scent location
        function updateScentLocation(scentNumber, value) {
            currentScores[`scent${scentNumber}Location`] = value;
        }

        // Add event listeners for scent locations
        document.addEventListener('DOMContentLoaded', function() {
            ['scent1Location', 'scent2Location', 'scent3Location', 'scent4Location'].forEach((id, index) => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('change', function() {
                        updateScentLocation(index + 1, this.value);
                    });
                }
            });
        });

        // Save scores to Firebase
        async function saveScores() {
            if (!currentRound) {
                showStatus('No round selected', 'error');
                return;
            }

            try {
                showStatus('Saving scores...', 'info');

                // Update scent locations from inputs
                currentScores.scent1Location = document.getElementById('scent1Location').value;
                currentScores.scent2Location = document.getElementById('scent2Location').value;
                currentScores.scent3Location = document.getElementById('scent3Location').value;
                currentScores.scent4Location = document.getElementById('scent4Location').value;

                // Add metadata
                currentScores.trialId = currentTrial.id;
                currentScores.trialName = currentTrial.clubName;
                currentScores.roundKey = currentRound.key;
                currentScores.className = currentRound.className;
                currentScores.judgeName = currentRound.judgeName;
                currentScores.roundNumber = currentRound.roundNumber;
                currentScores.lastUpdated = firebase.firestore.FieldValue.serverTimestamp();
                currentScores.updatedBy = currentUser.uid;

                const docId = `${currentTrial.id}_${currentRound.key}`;
                await db.collection('scores').doc(docId).set(currentScores);

                showStatus('Scores saved successfully!', 'success');
            } catch (error) {
                console.error('Error saving scores:', error);
                showStatus('Error saving scores: ' + error.message, 'error');
            }
        }

        // Export filled score sheet as PDF
        async function exportFilledScoreSheet() {
            if (!currentRound) {
                showStatus('No round selected', 'error');
                return;
            }

            try {
                showStatus('Generating filled score sheet...', 'info');

                // This would integrate with your existing PDF generation
                // For now, let's create a simple export
                const scoresData = {
                    trial: currentTrial.clubName,
                    class: currentRound.className,
                    judge: currentRound.judgeName,
                    date: currentRound.date,
                    round: currentRound.roundNumber,
                    scentLocations: {
                        scent1: currentScores.scent1Location || '',
                        scent2: currentScores.scent2Location || '',
                        scent3: currentScores.scent3Location || '',
                        scent4: currentScores.scent4Location || ''
                    },
                    participants: currentScores.participants || {}
                };

                // Create downloadable JSON for now (could be enhanced to PDF)
                const dataStr = JSON.stringify(scoresData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `${currentRound.className}_Round${currentRound.roundNumber}_Scores.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                showStatus('Score data exported successfully!', 'success');
            } catch (error) {
                console.error('Error exporting scores:', error);
                showStatus('Error exporting scores: ' + error.message, 'error');
            }
        }

        // Clear all scores for current round
        function clearAllScores() {
            if (!currentRound) {
                showStatus('No round selected', 'error');
                return;
            }

            if (confirm('Are you sure you want to clear all scores for this round? This cannot be undone.')) {
                currentScores = {};
                
                // Clear all inputs
                document.querySelectorAll('#scoringTable select, #scoringTable input').forEach(input => {
                    input.value = '';
                });
                
                // Clear scent locations
                ['scent1Location', 'scent2Location', 'scent3Location', 'scent4Location'].forEach(id => {
                    document.getElementById(id).value = '';
                });

                showStatus('All scores cleared', 'info');
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing score entry system...');
            init();
        });

        console.log('Score Entry System script loaded successfully');
    </script>
</body>
</html>
