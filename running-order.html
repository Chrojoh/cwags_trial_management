<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Running Order Management with Score Sheets</title>
    
    <!-- Firebase SDKs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-auth-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-firestore-compat.min.js"></script>
    
    <!-- Sortable.js for drag and drop -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <!-- PDF-lib for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 1.5rem;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn {
            padding: 0.8rem 1.5rem;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            margin: 0.25rem;
            text-decoration: none;
            display: inline-block;
        }

        .btn:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-info {
            background: #17a2b8;
        }

        .running-order-container {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .trial-selector {
            margin-bottom: 2rem;
        }

        .trial-selector select {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
        }

        .day-tabs-container {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 0.5rem;
            margin-bottom: 1.5rem;
            position: sticky;
            top: 20px;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .day-tabs {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .day-tab {
            flex: 1;
            min-width: 150px;
            padding: 0.75rem 1rem;
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            text-align: center;
            transition: all 0.3s ease;
        }

        .day-tab:hover {
            border-color: #667eea;
            color: #667eea;
        }

        .day-tab.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .running-order-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .score-sheet-controls {
            background: #e7f3ff;
            border: 2px solid #0066cc;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .score-sheet-controls h3 {
            color: #0066cc;
            margin-bottom: 1rem;
        }

        .rounds-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 2rem;
        }

        .round-column {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: #f8f9fa;
            min-height: 500px;
        }

        .round-header {
            background: #667eea;
            color: white;
            padding: 1rem;
            border-radius: 6px 6px 0 0;
            text-align: center;
            font-weight: bold;
        }

        .round-info {
            padding: 0.5rem 1rem;
            background: #e9ecef;
            border-bottom: 1px solid #dee2e6;
            text-align: center;
        }

        .round-info .judge-name {
            font-size: 1rem;
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.25rem;
        }

        .round-info .class-round {
            font-size: 0.9rem;
            color: #6c757d;
            font-weight: 500;
        }

        .round-actions {
            padding: 0.5rem 1rem;
            background: #fff;
            border-bottom: 1px solid #dee2e6;
            text-align: center;
        }

        .entries-list {
            min-height: 300px;
            padding: 1rem;
        }

        .entry-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            cursor: move;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .entry-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }

        .entry-item.sortable-ghost {
            opacity: 0.4;
        }

        .entry-item.sortable-drag {
            background: #e3f2fd;
            border-color: #2196f3;
        }

        .entry-text {
            font-weight: 600;
            color: #495057;
        }

        .entry-controls {
            display: flex;
            gap: 0.25rem;
        }

        .entry-controls button {
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .entry-controls button:hover {
            background: #5a6268;
        }

        .entry-type-regular {
            border-left: 4px solid #28a745;
        }

        .entry-type-feo {
            border-left: 4px solid #ffc107;
        }

        .status-message {
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 8px;
            display: none;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-info {
            background: #cce7ff;
            color: #0056b3;
            border: 1px solid #99d3ff;
        }

        .no-entries {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 2rem;
        }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            margin: 0.1rem;
        }

        @media (max-width: 768px) {
            .rounds-grid {
                grid-template-columns: 1fr;
            }
            
            .running-order-controls {
                flex-direction: column;
            }

            .day-tabs {
                flex-direction: column;
            }

            .day-tab {
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div>
                <h1>üìä Running Order Management</h1>
                <p>Organize running orders and generate score sheets</p>
            </div>
            <div>
                <a href="score-entry.html" class="btn btn-info">üìù Enter Scores</a>
                <a href="trial-secretary-dashboard.html" class="btn btn-secondary">‚Üê Back to Dashboard</a>
                <button class="btn btn-success" onclick="exportRunningOrder()">üì§ Export Excel</button>
                <button class="btn" onclick="saveRunningOrder()">üíæ Save Changes</button>
            </div>
        </div>

        <!-- Status Message -->
        <div class="status-message" id="statusMessage"></div>

        <!-- Running Order Container -->
        <div class="running-order-container">
            <!-- Trial Selector -->
            <div class="trial-selector">
                <label for="trialSelect"><strong>Select Trial:</strong></label>
                <select id="trialSelect" onchange="loadTrialRunningOrder()">
                    <option value="">Loading trials...</option>
                </select>
            </div>

            <!-- Score Sheet Controls -->
            <div class="score-sheet-controls" id="scoreSheetControls" style="display: none;">
                <h3>üìÑ Score Sheet Generation</h3>
                <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
                    <button class="btn btn-info" onclick="generateAllScoreSheets()">
                        üìã Generate All Score Sheets for Current Day
                    </button>
                    <button class="btn btn-warning" onclick="previewScoreSheet()">
                        üëÅÔ∏è Preview Score Sheet Format
                    </button>
                    <span style="color: #666; font-size: 0.9rem;">
                        Creates fillable PDF score sheets for each round with entrants pre-filled
                    </span>
                </div>
            </div>

            <!-- Day Tabs -->
            <div class="day-tabs-container" id="dayTabsContainer" style="display: none;">
                <div class="day-tabs" id="dayTabs">
                    <!-- Day tabs will be generated here -->
                </div>
            </div>

            <!-- Controls -->
            <div class="running-order-controls" id="runningOrderControls" style="display: none;">
                <button class="btn btn-secondary" onclick="randomizeAllOrders()">üé≤ Randomize Day</button>
                <button class="btn btn-secondary" onclick="sortAlphabetically()">üî§ Sort A-Z</button>
                <button class="btn btn-secondary" onclick="resetToOriginal()">‚Ü©Ô∏è Reset to Entry Order</button>
                <button class="btn btn-secondary" onclick="refreshRunningOrder()">üîÑ Refresh</button>
            </div>

            <!-- Rounds Grid -->
            <div class="rounds-grid" id="roundsGrid">
                <div class="no-entries">
                    Please select a trial to view running orders.
                </div>
            </div>
        </div>
    </div>

    <script>
        // C-WAGS Standard Class Order
const CWAGS_CLASS_ORDER = [
    'Patrol 1', 'Detective 2', 'Investigator 3', 'Super Sleuth 4', 'Private Inv', 'Det Diversions',
    'Ranger 1', 'Ranger 2', 'Ranger 3', 'Ranger 4', 'Ranger 5',
    'Dasher 3', 'Dasher 4', 'Dasher 5', 'Dasher 6',
    'Obedience 1', 'Obedience 2', 'Obedience 3', 'Obedience 4', 'Obedience 5',
    'Starter', 'Advanced', 'Pro', 'ARF',
    'Zoom 1', 'Zoom 1.5', 'Zoom 2',
    'Games 1', 'Games 2', 'Games 3', 'Games 4'
];
        
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBWpyM_lEpqdQWuKuLLZiW1SlloWsWkJCs",
            authDomain: "dog-trialing-system.firebaseapp.com",
            projectId: "dog-trialing-system",
            storageBucket: "dog-trialing-system.firebasestorage.app",
            messagingSenderId: "490812593982",
            appId: "1:490812593982:web:344776707566f8d9027e6f",
            measurementId: "G-EMLX58Y278"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ========================================
        // TIMEZONE-SAFE DATE UTILITIES
        // ========================================

        function createLocalDate(dateStr) {
            if (!dateStr) return null;
            if (typeof dateStr === 'string') {
                const dateWithTime = dateStr.includes('T') ? dateStr : dateStr + 'T12:00:00';
                return new Date(dateWithTime);
            }
            return new Date(dateStr);
        }

        function formatLocalDate(date) {
            if (!date || !(date instanceof Date)) return '';
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function getDateFromFirebase(firebaseDate) {
            if (!firebaseDate) return '';
            let date;
            if (firebaseDate.toDate) {
                date = firebaseDate.toDate();
            } else if (firebaseDate instanceof Date) {
                date = firebaseDate;
            } else if (typeof firebaseDate === 'string') {
                date = createLocalDate(firebaseDate);
            } else {
                return '';
            }
            return formatLocalDate(date);
        }

        // Global variables
        let currentUser = null;
        let currentTrial = null;
        let runningOrderData = {};
        let originalOrderData = {};
        let currentDay = 0;

        // Standard field names
        const STANDARD_FIELDS = {
            HANDLER_NAME: 'handlerName',
            DOG_CALL_NAME: 'dogCallName',
            JUDGE_NAME: 'judgeName',
            CLASS_NAME: 'className'
        };

        // Utility functions
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status-message status-${type}`;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        // Initialize the application
        async function init() {
            try {
                await new Promise((resolve, reject) => {
                    const unsubscribe = auth.onAuthStateChanged(async (user) => {
                        unsubscribe();
                        if (user) {
                            try {
                                const userDoc = await db.collection('users').doc(user.uid).get();
                                if (userDoc.exists) {
                                    currentUser = { uid: user.uid, ...userDoc.data() };
                                    resolve();
                                } else {
                                    reject(new Error('User profile not found'));
                                }
                            } catch (error) {
                                reject(error);
                            }
                        } else {
                            window.location.href = 'index.html';
                        }
                    });
                });

                await loadTrials();
            } catch (error) {
                console.error('Error initializing:', error);
                showStatus('Error initializing application: ' + error.message, 'error');
            }
        }

       // Load trials for the dropdown
async function loadTrials() {
    try {
        showStatus('Loading your trials...', 'info');

        const trialsSnapshot = await db.collection("trials")
            .where("createdBy", "==", currentUser.uid)
            .get();

        const trialSelect = document.getElementById('trialSelect');
        trialSelect.innerHTML = '<option value="">Select a trial...</option>';

        if (!trialsSnapshot.empty) {
            const trials = [];
            trialsSnapshot.forEach(doc => {
                trials.push({ id: doc.id, ...doc.data() });
            });

            trials.sort((a, b) => {
                const aTime = a.createdAt ? a.createdAt.seconds : 0;
                const bTime = b.createdAt ? b.createdAt.seconds : 0;
                return bTime - aTime;
            });

            trials.forEach(trial => {
                const option = document.createElement('option');
                option.value = trial.id;
                
                // Start with club name
                let trialLabel = trial.clubName || 'Unnamed Trial';
                
                // Add dates if available using timezone-safe formatting
                if (trial.days && trial.days.length > 0) {
                    const dates = trial.days
                        .filter(day => day.date)
                        .map(day => {
                            const localDate = createLocalDate(day.date);
                            return localDate.toLocaleDateString('en-US', { 
                                month: 'short', 
                                day: 'numeric',
                                timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
                            });
                        })
                        .join(', ');
                    if (dates) {
                        trialLabel += ` (${dates})`;
                    }
                }
                
                option.textContent = trialLabel;
                trialSelect.appendChild(option);
            });

            showStatus(`Found ${trials.length} trials`, 'success');
        } else {
            showStatus('No trials found', 'error');
        }
    } catch (error) {
        console.error('Error loading trials:', error);
        showStatus('Error loading trials: ' + error.message, 'error');
    }
}
        // Load running order for selected trial
        async function loadTrialRunningOrder() {
            const trialId = document.getElementById('trialSelect').value;
            
            if (!trialId) {
                document.getElementById('roundsGrid').innerHTML = '<div class="no-entries">Please select a trial to view running orders.</div>';
                document.getElementById('runningOrderControls').style.display = 'none';
                document.getElementById('dayTabsContainer').style.display = 'none';
                document.getElementById('scoreSheetControls').style.display = 'none';
                return;
            }

            try {
                showStatus('Loading trial entries...', 'info');

                const trialDoc = await db.collection('trials').doc(trialId).get();
                if (!trialDoc.exists) {
                    throw new Error('Trial not found');
                }

                currentTrial = { id: trialDoc.id, ...trialDoc.data() };

                if (currentTrial.days && Array.isArray(currentTrial.days)) {
                    currentTrial.days = currentTrial.days.map(day => ({
                        ...day,
                        date: day.date ? getDateFromFirebase(day.date) : null
                    }));
                }

                const entriesSnapshot = await db.collection('entries')
                    .where('trialId', '==', trialId)
                    .get();

                let existingOrder = {};
                try {
                    const orderDoc = await db.collection('running_orders').doc(trialId).get();
                    if (orderDoc.exists) {
                        existingOrder = orderDoc.data().roundOrders || {};
                    }
                } catch (error) {
                    console.log('No existing running order found, will create new one');
                }

                await processEntriesIntoRunningOrder(entriesSnapshot, existingOrder);

                showStatus(`Loaded running order for ${currentTrial.clubName}`, 'success');
                document.getElementById('runningOrderControls').style.display = 'flex';
                document.getElementById('scoreSheetControls').style.display = 'block';

            } catch (error) {
                console.error('Error loading trial running order:', error);
                showStatus('Error loading running order: ' + error.message, 'error');
            }
        }

        // Process entries into running order structure
        async function processEntriesIntoRunningOrder(entriesSnapshot, existingOrder) {
            runningOrderData = {};
            originalOrderData = {};

            console.log('üîç Processing trial structure:', currentTrial);

            if (currentTrial.days) {
                currentTrial.days.forEach((day, dayIndex) => {
                    runningOrderData[dayIndex] = {
                        dayNumber: dayIndex + 1,
                        date: day.date,
                        rounds: {}
                    };
                    originalOrderData[dayIndex] = { rounds: {} };
                    
                    if (day.classes) {
                        day.classes.forEach((cls, classIndex) => {
                            const className = cls.className || cls.class || cls.CLASS_NAME || `Class ${classIndex + 1}`;
                            
                            if (cls.rounds) {
                                cls.rounds.forEach((round, roundIndex) => {
                                    const roundKey = `${dayIndex}-${classIndex}-${roundIndex}`;
                                    const roundId = `day${dayIndex + 1}_${className}_round${roundIndex + 1}`.replace(/\s+/g, '_');
                                    const judgeName = round.judgeName || round.judge || round.JUDGE_NAME || 'Judge TBD';
                                    
                                    runningOrderData[dayIndex].rounds[roundKey] = {
                                        id: roundId,
                                        className: className,
                                        roundNumber: roundIndex + 1,
                                        judgeName: judgeName,
                                        entries: []
                                    };
                                    
                                    originalOrderData[dayIndex].rounds[roundKey] = { entries: [] };
                                });
                            }
                        });
                    }
                });
            }

            if (!entriesSnapshot.empty) {
                entriesSnapshot.forEach(doc => {
                    const entry = doc.data();
                    
                    if (entry.selectedEntries) {
                        entry.selectedEntries.forEach(selectedEntry => {
                            const dayIndex = selectedEntry.dayIndex;
                            let classIndex = currentTrial.days[dayIndex].classes.findIndex(c => {
                                const clsName = c.className || c.class || c.CLASS_NAME || '';
                                return clsName === selectedEntry.className;
                            });

                            let finalClassIndex;
                            if (classIndex !== -1) {
                                finalClassIndex = classIndex;
                            } else if (selectedEntry.classIndex !== undefined && selectedEntry.classIndex !== -1) {
                                finalClassIndex = selectedEntry.classIndex;
                            } else {
                                finalClassIndex = 0;
                            }

                            if (finalClassIndex >= currentTrial.days[dayIndex].classes.length) {
                                finalClassIndex = 0;
                            }

                            const roundKey = `${dayIndex}-${finalClassIndex}-${selectedEntry.roundIndex}`;
                            
                            if (runningOrderData[dayIndex] && runningOrderData[dayIndex].rounds[roundKey]) {
                                const entryItem = {
                                    id: doc.id + '_' + selectedEntry.entryId,
                                    handlerName: entry.handlerName.split(' ')[0],
                                    dogCallName: entry.dogCallName,
                                    entryType: selectedEntry.type,
                                    originalOrder: runningOrderData[dayIndex].rounds[roundKey].entries.length
                                };
                                runningOrderData[dayIndex].rounds[roundKey].entries.push(entryItem);
                                originalOrderData[dayIndex].rounds[roundKey].entries.push({ ...entryItem });
                            }
                        });
                    }
                });
            }

            Object.keys(existingOrder).forEach(roundKey => {
                const [dayIndex] = roundKey.split('-').map(Number);
                if (runningOrderData[dayIndex] && runningOrderData[dayIndex].rounds[roundKey] && existingOrder[roundKey]) {
                    const round = runningOrderData[dayIndex].rounds[roundKey];
                    const orderedEntries = [];
                    const unorderedEntries = [...round.entries];

                    existingOrder[roundKey].forEach(savedEntryId => {
                        const entryIndex = unorderedEntries.findIndex(e => e.id === savedEntryId);
                        if (entryIndex !== -1) {
                            orderedEntries.push(unorderedEntries.splice(entryIndex, 1)[0]);
                        }
                    });

                    orderedEntries.push(...unorderedEntries);
                    round.entries = orderedEntries;
                }
            });

            renderDayTabs();
            renderRunningOrder();
        }

        // Render day tabs
        function renderDayTabs() {
            const dayTabsContainer = document.getElementById('dayTabsContainer');
            const dayTabs = document.getElementById('dayTabs');
            
            if (Object.keys(runningOrderData).length === 0) {
                dayTabsContainer.style.display = 'none';
                return;
            }

            dayTabsContainer.style.display = 'block';
            dayTabs.innerHTML = '';

            Object.keys(runningOrderData).forEach((dayIndex, index) => {
                const dayData = runningOrderData[dayIndex];
                
                const dayDate = dayData.date 
                    ? createLocalDate(dayData.date).toLocaleDateString('en-US', { 
                        weekday: 'short', 
                        month: 'short', 
                        day: 'numeric' 
                    })
                    : `Day ${dayData.dayNumber}`;

                const tabButton = document.createElement('button');
                tabButton.type = 'button';
                tabButton.className = `day-tab ${index === 0 ? 'active' : ''}`;
                tabButton.onclick = () => showDay(parseInt(dayIndex));
                tabButton.textContent = dayDate;
                
                dayTabs.appendChild(tabButton);
            });

            const firstDayIndex = parseInt(Object.keys(runningOrderData)[0]);
            currentDay = firstDayIndex;
        }

        // Show specific day
        function showDay(dayIndex) {
            currentDay = dayIndex;
            
            document.querySelectorAll('.day-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            const dayTabs = document.querySelectorAll('.day-tab');
            const dayKeys = Object.keys(runningOrderData);
            const tabIndex = dayKeys.indexOf(dayIndex.toString());
            if (dayTabs[tabIndex]) {
                dayTabs[tabIndex].classList.add('active');
            }
            
            renderRunningOrder();
        }

        // Render the running order grid for current day
        function renderRunningOrder() {
            const roundsGrid = document.getElementById('roundsGrid');
            
            if (Object.keys(runningOrderData).length === 0) {
                roundsGrid.innerHTML = '<div class="no-entries">No entries found for this trial.</div>';
                return;
            }

            if (!runningOrderData[currentDay] || Object.keys(runningOrderData[currentDay].rounds).length === 0) {
                roundsGrid.innerHTML = '<div class="no-entries">No classes scheduled for this day.</div>';
                return;
            }

            const dayData = runningOrderData[currentDay];
            let html = '';

            Object.keys(dayData.rounds).forEach(roundKey => {
                const round = dayData.rounds[roundKey];
                
                html += `
                    <div class="round-column">
                        <div class="round-header">
                            ${dayData.date ? createLocalDate(dayData.date).toLocaleDateString() : 'Date TBD'}
                        </div>
                        <div class="round-info">
                            <div class="judge-name">${round.judgeName}</div>
                            <div class="class-round">${round.className} Round ${round.roundNumber}</div>
                        </div>
                        <div class="round-actions">
                            <button class="btn btn-sm btn-info" onclick="generateRoundScoreSheet('${roundKey}')">
                                üìã Generate Score Sheet
                            </button>
                        </div>
                        <div class="entries-list" id="entries_${roundKey}" data-round-key="${roundKey}">
                            ${round.entries.map((entry, index) => `
                                <div class="entry-item entry-type-${entry.entryType}" data-entry-id="${entry.id}">
                                    <span class="entry-text">${entry.handlerName} - ${entry.dogCallName}</span>
                                    <div class="entry-controls">
                                        <button onclick="moveEntryUp('${roundKey}', ${index})" title="Move Up">‚Üë</button>
                                        <button onclick="moveEntryDown('${roundKey}', ${index})" title="Move Down">‚Üì</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });

            roundsGrid.innerHTML = html;

            Object.keys(dayData.rounds).forEach(roundKey => {
                const entriesList = document.getElementById(`entries_${roundKey}`);
                if (entriesList) {
                    new Sortable(entriesList, {
                        animation: 150,
                        ghostClass: 'sortable-ghost',
                        dragClass: 'sortable-drag',
                        onEnd: function (evt) {
                            handleDragEnd(roundKey, evt.oldIndex, evt.newIndex);
                        }
                    });
                }
            });
        }

        // Handle drag and drop end
        function handleDragEnd(roundKey, oldIndex, newIndex) {
            if (oldIndex !== newIndex) {
                const dayData = runningOrderData[currentDay];
                const entries = dayData.rounds[roundKey].entries;
                const movedEntry = entries.splice(oldIndex, 1)[0];
                entries.splice(newIndex, 0, movedEntry);
                
                console.log(`Moved entry from position ${oldIndex} to ${newIndex} in round ${roundKey}`);
                showStatus('Entry order updated', 'success');
            }
        }

        // Move entry up
        function moveEntryUp(roundKey, index) {
            if (index > 0) {
                const dayData = runningOrderData[currentDay];
                const entries = dayData.rounds[roundKey].entries;
                [entries[index - 1], entries[index]] = [entries[index], entries[index - 1]];
                renderRunningOrder();
                showStatus('Entry moved up', 'success');
            }
        }

        // Move entry down
        function moveEntryDown(roundKey, index) {
            const dayData = runningOrderData[currentDay];
            const entries = dayData.rounds[roundKey].entries;
            if (index < entries.length - 1) {
                [entries[index], entries[index + 1]] = [entries[index + 1], entries[index]];
                renderRunningOrder();
                showStatus('Entry moved down', 'success');
            }
        }

        // Randomize running orders for current day
        function randomizeAllOrders() {
            if (confirm('This will randomize the running order for ALL rounds on the current day. Continue?')) {
                const dayData = runningOrderData[currentDay];
                Object.keys(dayData.rounds).forEach(roundKey => {
                    const entries = dayData.rounds[roundKey].entries;
                    for (let i = entries.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [entries[i], entries[j]] = [entries[j], entries[i]];
                    }
                });
                renderRunningOrder();
                showStatus('Running orders randomized for current day', 'success');
            }
        }

        // Sort alphabetically by handler name for current day
        function sortAlphabetically() {
            if (confirm('This will sort all entries alphabetically by handler name for the current day. Continue?')) {
                const dayData = runningOrderData[currentDay];
                Object.keys(dayData.rounds).forEach(roundKey => {
                    dayData.rounds[roundKey].entries.sort((a, b) => 
                        a.handlerName.localeCompare(b.handlerName)
                    );
                });
                renderRunningOrder();
                showStatus('Entries sorted alphabetically for current day', 'success');
            }
        }

        // Reset to original entry order for current day
        function resetToOriginal() {
            if (confirm('This will reset all running orders to the original entry order for the current day. Continue?')) {
                const dayData = runningOrderData[currentDay];
                const originalDayData = originalOrderData[currentDay];
                Object.keys(originalDayData.rounds).forEach(roundKey => {
                    if (dayData.rounds[roundKey]) {
                        dayData.rounds[roundKey].entries = [...originalDayData.rounds[roundKey].entries];
                    }
                });
                renderRunningOrder();
                showStatus('Running orders reset to original entry order for current day', 'success');
            }
        }

        // Refresh running order
        function refreshRunningOrder() {
            loadTrialRunningOrder();
        }

        // Save running order to Firebase
        async function saveRunningOrder() {
            if (!currentTrial) {
                showStatus('No trial selected', 'error');
                return;
            }

            try {
                showStatus('Saving running order...', 'info');

                const roundOrders = {};
                Object.keys(runningOrderData).forEach(dayIndex => {
                    const dayData = runningOrderData[dayIndex];
                    Object.keys(dayData.rounds).forEach(roundKey => {
                        roundOrders[roundKey] = dayData.rounds[roundKey].entries.map(entry => entry.id);
                    });
                });

                await db.collection('running_orders').doc(currentTrial.id).set({
                    trialId: currentTrial.id,
                    trialName: currentTrial.clubName,
                    roundOrders: roundOrders,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: currentUser.uid
                });

                showStatus('Running order saved successfully!', 'success');
            } catch (error) {
                console.error('Error saving running order:', error);
                showStatus('Error saving running order: ' + error.message, 'error');
            }
        }

        // Export running order to Excel
        async function exportRunningOrder() {
            if (!currentTrial || Object.keys(runningOrderData).length === 0) {
                showStatus('No running order data to export', 'error');
                return;
            }

            try {
                showStatus('Preparing Excel export...', 'info');

                const dayData = runningOrderData[currentDay];
                if (!dayData) {
                    showStatus('No data for current day', 'error');
                    return;
                }

                let csvContent = "data:text/csv;charset=utf-8,";
                
                const rounds = Object.values(dayData.rounds);
                const maxEntries = Math.max(...rounds.map(r => r.entries.length));
                
                csvContent += rounds.map(round => 
                    `"${dayData.date ? createLocalDate(dayData.date).toLocaleDateString() : 'Date TBD'}"`
                ).join(',') + '\n';
                
                csvContent += rounds.map(round => 
                    `"${round.judgeName}"`
                ).join(',') + '\n';
                
                csvContent += rounds.map(round => 
                    `"${round.className} Round ${round.roundNumber}"`
                ).join(',') + '\n';

                for (let i = 0; i < maxEntries; i++) {
                    csvContent += rounds.map(round => 
                        round.entries[i] ? `"${round.entries[i].handlerName} - ${round.entries[i].dogCallName}"` : '""'
                    ).join(',') + '\n';
                }

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                
                const dayDate = dayData.date ? createLocalDate(dayData.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : `Day-${dayData.dayNumber}`;
                link.setAttribute("download", `running-order-${currentTrial.clubName.replace(/\s+/g, '-')}-${dayDate}.csv`);
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showStatus('Running order exported successfully!', 'success');
            } catch (error) {
                console.error('Error exporting running order:', error);
                showStatus('Error exporting running order: ' + error.message, 'error');
            }
        }

        // ========================================
        // SCORE SHEET GENERATION FUNCTIONS
        // ========================================

        // Generate score sheet for a specific round
        async function generateRoundScoreSheet(roundKey) {
            try {
                showStatus('Generating score sheet...', 'info');
                
                const dayData = runningOrderData[currentDay];
                const round = dayData.rounds[roundKey];
                
                if (!round || round.entries.length === 0) {
                    showStatus('No entries found for this round', 'error');
                    return;
                }

                const pdfDoc = await PDFLib.PDFDocument.create();
                const page = pdfDoc.addPage([612, 792]); // US Letter size
                
                await createScoreSheetPage(pdfDoc, page, round, dayData);
                
                const pdfBytes = await pdfDoc.save();
                downloadPDF(pdfBytes, `${round.className}_Round${round.roundNumber}_ScoreSheet.pdf`);
                
                showStatus('Score sheet generated successfully!', 'success');
            } catch (error) {
                console.error('Error generating score sheet:', error);
                showStatus('Error generating score sheet: ' + error.message, 'error');
            }
        }

        // Generate all score sheets for current day
        async function generateAllScoreSheets() {
            try {
                showStatus('Generating all score sheets for current day...', 'info');
                
                const dayData = runningOrderData[currentDay];
                const rounds = Object.values(dayData.rounds).filter(round => round.entries.length > 0);
                
                if (rounds.length === 0) {
                    showStatus('No rounds with entries found for current day', 'error');
                    return;
                }

                const pdfDoc = await PDFLib.PDFDocument.create();
                
                for (const round of rounds) {
                    const page = pdfDoc.addPage([612, 792]);
                    await createScoreSheetPage(pdfDoc, page, round, dayData);
                }
                
                const pdfBytes = await pdfDoc.save();
                const dayDate = dayData.date ? createLocalDate(dayData.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : `Day-${dayData.dayNumber}`;
                downloadPDF(pdfBytes, `${currentTrial.clubName}_${dayDate}_ScoreSheets.pdf`);
                
                showStatus(`Generated ${rounds.length} score sheets successfully!`, 'success');
            } catch (error) {
                console.error('Error generating score sheets:', error);
                showStatus('Error generating score sheets: ' + error.message, 'error');
            }
        }

        // Create a score sheet page
        async function createScoreSheetPage(pdfDoc, page, round, dayData) {
            const { width, height } = page.getSize();
            const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
            const boldFont = await pdfDoc.embedFont(PDFLib.StandardFonts.HelveticaBold);

            // Header - centered
            const headerText = 'Scent Detective Master Score Sheet';
            const headerWidth = headerText.length * 9; // Approximate width
            page.drawText(headerText, {
                x: (width - headerWidth) / 2,
                y: height - 60,
                size: 16,
                font: boldFont,
            });

            // Date - top right
            const dateStr = dayData.date ? createLocalDate(dayData.date).toLocaleDateString() : '____________';
            page.drawText(`Date: ${dateStr}`, {
                x: width - 150,
                y: height - 90,
                size: 12,
                font: font,
            });

            // Class info - left side
            page.drawText(`CLASS: ${round.className}`, {
                x: 50,
                y: height - 110,
                size: 12,
                font: boldFont,
            });

            // Round checkboxes - positioned like original
            const rounds = [1, 2, 3, 4];
            let roundX = 300;
            page.drawText('Round', {
                x: roundX - 50,
                y: height - 108,
                size: 12,
                font: boldFont,
            });

            rounds.forEach((roundNum, index) => {
                const isCurrentRound = roundNum === round.roundNumber;
                const boxX = roundX + (index * 40);
                
                // Draw checkbox
                page.drawRectangle({
                    x: boxX,
                    y: height - 115,
                    width: 12,
                    height: 12,
                    borderColor: PDFLib.rgb(0, 0, 0),
                    borderWidth: 1,
                });

                // Mark current round with X
                if (isCurrentRound) {
                    page.drawText('X', {
                        x: boxX + 2,
                        y: height - 113,
                        size: 10,
                        font: boldFont,
                    });
                }

                // Round number
                page.drawText(roundNum.toString(), {
                    x: boxX + 16,
                    y: height - 113,
                    size: 10,
                    font: font,
                });
            });

            // Scent locations section
            const scentY = height - 150;
            const scentSpacing = 125;
            ['Scent 1', 'Scent 2', 'Scent 3', 'Scent 4'].forEach((scent, index) => {
                const scentX = 50 + (index * scentSpacing);
                page.drawText(scent, {
                    x: scentX,
                    y: scentY,
                    size: 10,
                    font: boldFont,
                });
                page.drawText('Located in/on:', {
                    x: scentX,
                    y: scentY - 15,
                    size: 8,
                    font: font,
                });
                // Draw line for location
                page.drawLine({
                    start: { x: scentX, y: scentY - 30 },
                    end: { x: scentX + 110, y: scentY - 30 },
                    thickness: 1,
                });
            });

            // Faults section - wrapped properly
            const faultsY = height - 200;
            page.drawText('Faults: Dropped Food; Dog stops working; Handler guiding dog; Incorrect find; Destructive behavior;', {
                x: 50,
                y: faultsY,
                size: 8,
                font: font,
            });
            page.drawText('Disturbing search area by dog or handler; Verbally naming item; Continue search after "alert";', {
                x: 50,
                y: faultsY - 12,
                size: 8,
                font: font,
            });
            page.drawText('SR crossing line less than half.', {
                x: 50,
                y: faultsY - 24,
                size: 8,
                font: font,
            });

            // Table - adjusted to fit page width better
            const tableY = height - 250;
            const tableWidth = width - 100; // Leave 50px margin on each side
            const colWidths = [110, 50, 50, 50, 50, 60, 60, 50, 60]; // Adjusted column widths
            let currentX = 50;

            const headers = ['Team Dog - Handler', 'Scent 1', 'Scent 2', 'Scent 3', 'Scent 4', 'Fault', 'Fault', 'Time', 'Pass/Fail'];
            
            // Draw table headers
            headers.forEach((header, index) => {
                page.drawRectangle({
                    x: currentX,
                    y: tableY,
                    width: colWidths[index],
                    height: 20,
                    borderColor: PDFLib.rgb(0, 0, 0),
                    borderWidth: 1,
                });
                
                // Center text in header cells
                const textWidth = header.length * 4; // Approximate text width
                const textX = currentX + (colWidths[index] - textWidth) / 2;
                page.drawText(header, {
                    x: Math.max(currentX + 2, textX),
                    y: tableY + 6,
                    size: 7,
                    font: boldFont,
                });
                
                currentX += colWidths[index];
            });

            // Entry rows
            let rowY = tableY;
            round.entries.forEach((entry, index) => {
                rowY -= 25;
                currentX = 50;

                // Draw all cells for this row
                colWidths.forEach((width, colIndex) => {
                    page.drawRectangle({
                        x: currentX,
                        y: rowY,
                        width: width,
                        height: 25,
                        borderColor: PDFLib.rgb(0, 0, 0),
                        borderWidth: 1,
                    });

                    // Fill in team name for first column
                    if (colIndex === 0) {
                        const teamText = `${entry.handlerName} - ${entry.dogCallName}`;
                        page.drawText(teamText, {
                            x: currentX + 3,
                            y: rowY + 8,
                            size: 8,
                            font: font,
                        });
                    }
                    
                    currentX += width;
                });
            });

            // Judge signature section
            const sigY = Math.max(rowY - 60, 80);
            page.drawText(`Judge: ${round.judgeName}`, {
                x: 50,
                y: sigY,
                size: 12,
                font: boldFont,
            });
            
            page.drawText('Signature: ________________________________', {
                x: 250,
                y: sigY,
                size: 10,
                font: font,
            });

            // Copyright at bottom
            page.drawText('Copyright ¬© by Canine‚ÄìWork And Games, LLC, 2024', {
                x: 50,
                y: 30,
                size: 8,
                font: font,
            });
        }

        // Preview score sheet format
        async function previewScoreSheet() {
            try {
                showStatus('Generating preview...', 'info');
                
                // Create a sample round for preview
                const sampleRound = {
                    className: 'Sample Class',
                    roundNumber: 1,
                    judgeName: 'Sample Judge',
                    entries: [
                        { handlerName: 'John', dogCallName: 'Buddy', entryType: 'regular' },
                        { handlerName: 'Jane', dogCallName: 'Luna', entryType: 'regular' },
                        { handlerName: 'Bob', dogCallName: 'Max', entryType: 'feo' }
                    ]
                };

                const sampleDay = {
                    date: formatLocalDate(new Date())
                };

                const pdfDoc = await PDFLib.PDFDocument.create();
                const page = pdfDoc.addPage([612, 792]);
                
                await createScoreSheetPage(pdfDoc, page, sampleRound, sampleDay);
                
                const pdfBytes = await pdfDoc.save();
                downloadPDF(pdfBytes, 'ScoreSheet_Preview.pdf');
                
                showStatus('Preview generated successfully!', 'success');
            } catch (error) {
                console.error('Error generating preview:', error);
                showStatus('Error generating preview: ' + error.message, 'error');
            }
        }

        // Download PDF helper function
        function downloadPDF(pdfBytes, filename) {
            const blob = new Blob([pdfBytes], { type: 'application/pdf' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing enhanced running order management...');
            init();
        });

        console.log('Enhanced Running Order Management with Score Sheets script loaded successfully');
    </script>
</body>
</html>
