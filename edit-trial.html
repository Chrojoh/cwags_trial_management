<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trial Entry Form</title>
    
    <!-- Firebase SDKs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-auth-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-firestore-compat.min.js"></script>
    
    <!-- SheetJS for Excel processing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        /* Back to Dashboard Button */
        .back-to-dashboard {
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            padding: 15px 20px;
        }

        .back-button {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s ease;
        }

        .back-button:hover {
            background: #5a6268;
        }

        /* Status Messages */
        .status-message {
            padding: 1rem;
            margin: 1rem;
            border-radius: 8px;
            display: none;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-info {
            background: #cce7ff;
            color: #0056b3;
            border: 1px solid #99d3ff;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        /* Trial Selection (Secretary Only) */
        .trial-selection {
            background: #f8f9fa;
            padding: 1.5rem;
            border-bottom: 1px solid #e9ecef;
        }

        .trial-selection h3 {
            color: #495057;
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }

        /* Shareable Link Section (Secretary Only) */
        .shareable-link {
            background: #d4edda;
            border: 2px solid #28a745;
            border-radius: 8px;
            padding: 20px;
            margin: 20px;
            display: none;
        }

        .shareable-link h3 {
            color: #28a745;
            margin-bottom: 15px;
        }

        .link-display {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .link-url {
            font-family: monospace;
            background: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
            word-break: break-all;
            color: #28a745;
            margin-bottom: 10px;
        }

        .link-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-copy, .btn-test {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
        }

        .btn-copy {
            background: #17a2b8;
            color: white;
        }

        .btn-test {
            background: #28a745;
            color: white;
        }

        /* Form Styling */
        .form-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 1rem;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group.required label::after {
            content: " *";
            color: #dc3545;
            font-weight: bold;
        }

        label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #495057;
        }

        input, select, textarea {
            padding: 0.75rem;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Waiver Section */
        .waiver-section {
            background: #fff8e1;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 20px;
            display: none;
        }

        .waiver-content {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 1rem;
            background: white;
            border-radius: 6px;
            font-size: 0.9rem;
            line-height: 1.4;
            margin-bottom: 1rem;
        }

        .waiver-agreement {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
        }

        .waiver-agreement input[type="checkbox"] {
            margin-top: 0.2rem;
            width: auto;
        }

        /* Entry Form */
        .entry-form {
            padding: 2rem;
            display: none;
        }

        .form-section {
            margin-bottom: 2rem;
        }

        .form-section h3 {
            color: #495057;
            margin-bottom: 1rem;
            font-size: 1.3rem;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 0.5rem;
        }

        .form-section.primary {
            background: #f0f8ff;
            border: 2px solid #0066cc;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .form-section.primary h3 {
            color: #0066cc;
            border-bottom-color: #0066cc;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        /* Day Tabs */
        .day-tabs-container {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 0.5rem;
            margin-bottom: 1.5rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .day-tabs {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .day-tab {
            flex: 1;
            min-width: 150px;
            padding: 0.75rem 1rem;
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            text-align: center;
            transition: all 0.3s ease;
        }

        .day-tab:hover {
            border-color: #0066cc;
            color: #0066cc;
        }

        .day-tab.active {
            background: #0066cc;
            color: white;
            border-color: #0066cc;
        }

        /* Class Items */
        .class-entries-container {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
        }

        .class-day-content {
            display: none;
        }

        .class-day-content.active {
            display: block;
        }

        .class-item {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            overflow: hidden;
            transition: box-shadow 0.3s ease;
        }

        .class-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .class-header {
            background: #28a745;
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .class-name {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .rounds-container {
            padding: 1rem;
            background: #fff;
        }

        .round-item {
            background: #f0f8ff;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .round-details {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .judge-name {
            font-weight: 600;
            color: #495057;
        }

        .entry-options {
            display: flex;
            gap: 0.5rem;
        }

        .entry-button {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
            white-space: nowrap;
        }

        .entry-button.regular {
            background: #d4edda;
            color: #155724;
            border: 2px solid #28a745;
        }

        .entry-button.regular:hover {
            background: #28a745;
            color: white;
        }

        .entry-button.regular.selected {
            background: #155724;
            color: white;
            box-shadow: 0 0 0 3px rgba(21, 87, 36, 0.4);
        }

        .entry-button.feo {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffc107;
        }

        .entry-button.feo:hover {
            background: #ffc107;
            color: #212529;
        }

        .entry-button.feo.selected {
            background: #856404;
            color: white;
            box-shadow: 0 0 0 3px rgba(133, 100, 4, 0.4);
        }

        /* Submit Section */
        .submit-section {
            background: #e7f3ff;
            border: 2px solid #0066cc;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            text-align: center;
            display: none;
        }

        .submit-section.show {
            display: block;
        }

        .btn-submit {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 1rem 3rem;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 200px;
        }

        .btn-submit:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
        }

        .btn-submit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Utility Classes */
        .hidden {
            display: none;
        }

        .loading-message {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .error-message {
            background: #f8d7da;
            border: 2px solid #dc3545;
            color: #721c24;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
            margin: 2rem;
        }

        .success-message {
            background: #d4edda;
            border: 2px solid #28a745;
            color: #155724;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
            margin: 2rem;
            display: none;
        }

        /* Entry Summary */
        .entry-summary {
            background: #e7f3ff;
            border: 2px solid #0066cc;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            display: none;
        }

        .summary-title {
            font-weight: 600;
            color: #0066cc;
            margin-bottom: 1rem;
        }

        .selected-entries {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .selected-entry {
            background: white;
            padding: 0.5rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 6px;
            border-left: 4px solid #28a745;
        }

        @media (max-width: 768px) {
            .container {
                margin: 0;
                border-radius: 0;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .day-tabs {
                flex-direction: column;
            }

            .day-tab {
                min-width: auto;
            }

            .round-item {
                flex-direction: column;
                align-items: stretch;
                gap: 0.75rem;
            }

            .entry-options {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1 id="trialTitle">🏆 Trial Entry Form</h1>
            <p id="trialSubtitle">Complete your entry for this C-WAGS trial</p>
        </div>

        <!-- Back to Dashboard Button (Secretary Only) -->
        <div class="back-to-dashboard" id="backToDashboard">
            <a href="trial-secretary-dashboard.html" class="back-button">
                ← Back to Dashboard
            </a>
        </div>

        <!-- Status Messages -->
        <div class="status-message" id="statusMessage"></div>

        <!-- Loading Message -->
        <div class="loading-message" id="loadingMessage">
            🔄 Loading entry form...
        </div>

        <!-- Error Message -->
        <div class="error-message hidden" id="errorMessage">
            <h3>❌ Unable to Load Entry Form</h3>
            <p id="errorText">An error occurred while loading the entry form.</p>
            <button onclick="window.location.reload()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
                Retry
            </button>
        </div>

        <!-- Trial Selection (Secretary Only) -->
        <div class="trial-selection hidden" id="trialSelectionSection">
            <h3>🎯 Select Trial</h3>
            <div class="form-group required full-width">
                <label for="trialSelection">Choose which trial to create entry form for:</label>
                <select id="trialSelection" required style="font-size: 1.1rem; padding: 1rem;">
                    <option value="">Loading available trials...</option>
                </select>
            </div>
        </div>

        <!-- Shareable Link Section (Secretary Only) -->
        <div class="shareable-link" id="shareableLinkSection">
            <h3>🔗 Shareable Entry Link</h3>
            <p>Share this link with participants so they can enter from home:</p>
            <div class="link-display">
                <div class="link-url" id="shareableUrl">
                    <!-- Generated URL will appear here -->
                </div>
                <div class="link-actions">
                    <button class="btn-copy" onclick="copyShareableLink()">📋 Copy Link</button>
                    <button class="btn-test" onclick="testShareableLink()">🔗 Test Link</button>
                </div>
            </div>
        </div>

        <!-- C-WAGS Waiver Section -->
        <div class="waiver-section" id="waiverSection">
            <h3>⚠️ C-WAGS Disclaimer & Liability Waiver</h3>
            <div class="waiver-content">
                <p><strong>DISCLAIMER -- MUST BE SENT WITH ENTRY</strong></p>
                <p>I/we acknowledge that I am/we are familiar with the current rules applying to Canine-Work And GameS Trials. I/we agree that the Host Club holding the Trial has the right to refuse entry for cause which the Host Club shall deem to be sufficient. Upon acceptance of this entry, I/we agree to hold Canine-Work And GameS, LLC, and its members and officers, this Host Club, its members, directors, officers, agents, show secretary, show chairperson, show committee and the owner or lessor of the premises and any employees of the aforementioned parties, any sponsors of this event, harmless from any claim or loss or injury which may be alleged to have been caused directly or indirectly to any person or thing by the act of this dog or handler while in or upon the show trial premises or grounds or near any entrance thereto, and I/we further agree to hold the fore mentioned parties harmless from any claim or loss of this dog by disappearance, theft, death or otherwise, and from any claim for damage or injury to the dog, whether any claim be caused or alleged to be caused by the negligence of the Host Club or any of the parties aforementioned, or by the negligence of any other person, or any other cause or causes.</p>
                <p>I/we hereby assume sole responsibility for and agree to indemnify and save the aforementioned parties harmless from any and all loss and expense (including legal fees) by reason of the liability imposed by law upon any of the aforementioned parties for damage because of bodily injuries, including death at any time resulting there from, sustained by any person or persons, including myself/ourselves or on account of damage to property, arising out of or in consequence of my/our participation in the Trial, howsoever such injuries, death or damage to property may be caused and whether or not the same may have been caused by negligence of the aforementioned parties or any of their employees or agents, or any other persons.</p>
                <p><strong>I/we agree to abide by the rules of C-WAGS currently in effect at the time of the trial. I/we testify that the dog entered is healthy and vaccinated or titered. I/we certify that the dog entered is not dangerous to any person or other dog.</strong></p>
            </div>
            <div class="waiver-agreement">
                <input type="checkbox" id="waiverAccepted" required>
                <label for="waiverAccepted">
                    <strong>I have read, understood, and agree to the complete C-WAGS disclaimer and all terms above.</strong>
                </label>
            </div>
        </div>

        <!-- Entry Form -->
        <div class="entry-form" id="entryFormContainer">
            <!-- Success Message -->
            <div id="successMessage" class="success-message">
                <h3>✅ Entry Submitted Successfully!</h3>
                <p>The entry has been recorded for this trial.</p>
                <button class="btn-submit" onclick="resetForm()">Enter Another Participant</button>
            </div>

            <form id="entryForm">
                <!-- Registration Number Lookup -->
                <div class="form-section primary">
                    <h3>🔍 C-WAGS Registration Lookup</h3>
                    <div class="form-group full-width">
                        <label>C-WAGS Registration Number (optional)</label>
                        <input type="text" id="cwagsNumber" placeholder="XX-XXXX-XX" 
                               style="font-size: 1.2rem; font-weight: bold; background: #f0f8ff;">
                        <small style="color: #666; margin-top: 0.5rem; display: block;">
                            💡 Enter registration number first - handler and dog info will auto-fill if found
                        </small>
                    </div>
                    <div id="lookupStatus" class="status-message"></div>
                </div>

                <!-- Handler Information -->
                <div class="form-section">
                    <h3>👤 Handler Information</h3>
                    <div class="form-row">
                        <div class="form-group required">
                            <label>Handler Name</label>
                            <input type="text" id="handlerName" required placeholder="Will auto-fill from registration">
                        </div>
                        <div class="form-group">
                            <label>Phone Number</label>
                            <input type="tel" id="handlerPhone" placeholder="(xxx) xxx-xxxx">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Email Address</label>
                            <input type="email" id="handlerEmail" placeholder="handler@email.com">
                        </div>
                        <div class="form-group">
                            <label>Emergency Contact</label>
                            <input type="text" id="emergencyContact" placeholder="Name and phone number">
                        </div>
                    </div>
                </div>

                <!-- Dog Information -->
                <div class="form-section">
                    <h3>🐕 Dog Information</h3>
                    <div class="form-row">
                        <div class="form-group required">
                            <label>Dog's Call Name</label>
                            <input type="text" id="dogCallName" required placeholder="Will auto-fill from registration">
                        </div>
                        <div class="form-group">
                            <label>Breed</label>
                            <input type="text" id="dogBreed" placeholder="Enter breed">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Date of Birth</label>
                            <input type="date" id="dogBirthdate">
                        </div>
                        <div class="form-group">
                            <label>Sex</label>
                            <select id="dogSex">
                                <option value="">Select...</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Male Neutered">Male Neutered</option>
                                <option value="Female Spayed">Female Spayed</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Junior Handler (Under 18)</label>
                            <select id="juniorHandler">
                                <option value="No">No</option>
                                <option value="Yes">Yes</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Class Entries Section -->
                <div class="form-section">
                    <h3>🎯 Class Entries</h3>
                    
                    <!-- Entry Summary -->
                    <div class="entry-summary" id="entrySummary">
                        <div class="summary-title">Selected Entries:</div>
                        <ul class="selected-entries" id="selectedEntriesList">
                        </ul>
                        <div style="margin-top: 1rem; font-weight: 600; color: #0066cc;">
                            Total Fee: $<span id="totalFee">0.00</span>
                        </div>
                    </div>

                    <!-- Submit Section -->
                    <div class="submit-section" id="submitSection">
                        <h4 style="margin-bottom: 1rem; color: #0066cc;">Ready to Submit Entry?</h4>
                        <button type="button" class="btn-submit" id="submitEntry" disabled>
                            Submit Entry
                        </button>
                        <p style="margin-top: 1rem; color: #666; font-size: 0.9rem;">
                            Please review your selections before submitting.
                        </p>
                    </div>

                    <!-- Day Tabs -->
                    <div class="day-tabs-container">
                        <div class="day-tabs" id="dayTabs">
                            <!-- Tabs will be generated from trial data -->
                        </div>
                    </div>

                    <!-- Class Entries -->
                    <div class="class-entries-container" id="classEntriesContainer">
                        <div style="text-align: center; padding: 2rem; color: #666;">
                            Please select a trial to see available classes.
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        // C-WAGS Standard Class Order
const CWAGS_CLASS_ORDER = [
    'Patrol 1', 'Detective 2', 'Investigator 3', 'Super Sleuth 4', 'Private Inv', 'Det Diversions',
    'Ranger 1', 'Ranger 2', 'Ranger 3', 'Ranger 4', 'Ranger 5',
    'Dasher 3', 'Dasher 4', 'Dasher 5', 'Dasher 6',
    'Obedience 1', 'Obedience 2', 'Obedience 3', 'Obedience 4', 'Obedience 5',
    'Starter', 'Advanced', 'Pro', 'ARF',
    'Zoom 1', 'Zoom 1.5', 'Zoom 2',
    'Games 1', 'Games 2', 'Games 3', 'Games 4'
];
        
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBWpyM_lEpqdQWuKuLLZiW1SlloWsWkJCs",
            authDomain: "dog-trialing-system.firebaseapp.com",
            projectId: "dog-trialing-system",
            storageBucket: "dog-trialing-system.firebasestorage.app",
            messagingSenderId: "490812593982",
            appId: "1:490812593982:web:344776707566f8d9027e6f",
            measurementId: "G-EMLX58Y278"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Global variables
        let currentTrialData = null;
        let registrationData = [];
        let availableTrials = [];
        let isSecretary = false;
        let currentUser = null;
        let selectedEntries = [];
        let totalFee = 0;

        // Standard field names
        const STANDARD_FIELDS = {
            HANDLER_NAME: 'handlerName',
            DOG_CALL_NAME: 'dogCallName',
            JUDGE_NAME: 'judgeName',
            CLASS_NAME: 'className',
            CWAGS_NUMBER: 'cwagsNumber'
        };

        // Fee structure (default values)
        let fees = {
            regular: 35.00,
            feo: 25.00,
            juniorHandler: 20.00
        };

       // Show status messages - FIXED VERSION with null check
function showStatus(message, isError = false) {
    const statusDiv = document.getElementById('statusMessage');
    
    // Add null check to prevent the error
    if (statusDiv) {
        statusDiv.textContent = message;
        statusDiv.className = 'status-message ' + (isError ? 'status-error' : 'status-success');
        statusDiv.style.display = 'block';
        
        setTimeout(() => {
            // Check again in case element was removed during timeout
            if (statusDiv && statusDiv.parentNode) {
                statusDiv.style.display = 'none';
            }
        }, 5000);
    } else {
        // Fallback if statusMessage element doesn't exist
        console.log(`[${isError ? 'ERROR' : 'SUCCESS'}] ${message}`);
    }
}

        function showElement(id) {
            const element = document.getElementById(id);
            if (element) {
                element.classList.remove('hidden');
                element.style.display = 'block';
            }
        }

        function hideElement(id) {
            const element = document.getElementById(id);
            if (element) {
                element.classList.add('hidden');
                element.style.display = 'none';
            }
        }

        function showError(message) {
            console.error(message);
            hideElement('loadingMessage');
            document.getElementById('errorText').textContent = message;
            showElement('errorMessage');
        }

        // Initialize the application
        async function init() {
            console.log("🚀 Initializing entry form application...");
            
            try {
                // Check URL parameters for direct trial link
                const urlParams = new URLSearchParams(window.location.search);
                const trialId = urlParams.get('trial');

                if (trialId) {
                    // Load specific trial for public entry
                    console.log("🔗 Loading specific trial for public entry:", trialId);
                    await loadSpecificTrial(trialId);
                } else {
                    // Normal secretary view - need authentication
                    console.log("👨‍💼 Setting up secretary view");
                    isSecretary = true;
                    await setupSecretaryView();
                }

                // Load registration data
                await loadRegistrationData();

                // Setup form event listeners
                setupFormEventListeners();
                
            } catch (error) {
                console.error("❌ Error initializing application:", error);
                showError("Failed to initialize entry form: " + error.message);
            }
        }

        // Load registration data from Firebase registry
        async function loadRegistrationData() {
            try {
                console.log("📊 Loading registration data from Firebase registry...");
                showStatus('🔄 Loading registration data...', 'info');
                
                // Load from Firebase registry collection
                const registrationsSnapshot = await db.collection('registrations').get();
                
                if (!registrationsSnapshot.empty) {
                    registrationData = [];
                    registrationsSnapshot.forEach(doc => {
                        const regData = { id: doc.id, ...doc.data() };
                        registrationData.push(regData);
                    });
                    
                    console.log(`✅ Loaded ${registrationData.length} registrations from Firebase registry`);
                    console.log("📋 Sample registrations:", registrationData.slice(0, 2));
                    showStatus(`✅ Loaded ${registrationData.length} registrations from registry`, 'success');
                } else {
                    console.log("📊 No registrations found in Firebase registry");
                    registrationData = [];
                    showStatus('ℹ️ No registrations in registry yet. New entries will be saved.', 'info');
                }
                
            } catch (error) {
                console.error("❌ Error loading registration data:", error);
                registrationData = [];
                showStatus(`❌ Error loading registration data: ${error.message}`, 'error');
            }
        }

        // Setup secretary view with authentication
        async function setupSecretaryView() {
            try {
                console.log("🔐 Setting up secretary authentication...");
                
                // Wait for authentication state
                await new Promise((resolve, reject) => {
                    const unsubscribe = auth.onAuthStateChanged(async (user) => {
                        unsubscribe();
                        if (user) {
                            try {
                                console.log("🔍 Loading user profile for:", user.email);
                                
                                const userDoc = await db.collection('users').doc(user.uid).get();
                                if (userDoc.exists) {
                                    currentUser = { uid: user.uid, ...userDoc.data() };
                                    console.log("✅ User profile loaded:", currentUser.firstName, currentUser.lastName, "Role:", currentUser.role);
                                    resolve();
                                } else {
                                    reject(new Error('User profile not found'));
                                }
                            } catch (error) {
                                reject(error);
                            }
                        } else {
                            reject(new Error('User not authenticated'));
                        }
                    });
                });

                console.log("🔍 Loading trials for user:", currentUser.uid);
                showStatus('🔄 Loading your trials...', 'info');

                // Load trials - SIMPLIFIED QUERY (no orderBy to avoid index requirement)
                const trialsSnapshot = await db.collection("trials")
                    .where("createdBy", "==", currentUser.uid)
                    .get();
                
                console.log("📊 Trials query result:", {
                    empty: trialsSnapshot.empty,
                    size: trialsSnapshot.size
                });
                
                if (!trialsSnapshot.empty) {
                    availableTrials = [];
                    trialsSnapshot.forEach(doc => {
                        const trialData = { id: doc.id, ...doc.data() };
                        console.log("📋 Found trial:", trialData.clubName, "ID:", doc.id);
                        availableTrials.push(trialData);
                    });
                    
                    // Sort by creation date manually (newest first)
                    availableTrials.sort((a, b) => {
                        const aTime = a.createdAt ? a.createdAt.seconds : 0;
                        const bTime = b.createdAt ? b.createdAt.seconds : 0;
                        return bTime - aTime;
                    });
                    
                    console.log(`✅ Loaded ${availableTrials.length} trials for dropdown`);
                    
                    hideElement('loadingMessage');
                    showElement('trialSelectionSection');
                    showElement('backToDashboard'); // Show dashboard button for secretary
                    populateTrialSelector();
                    showStatus(`✅ Found ${availableTrials.length} trials`, 'success');
                    
                } else {
                    console.warn("⚠️ No trials found for this user");
                    throw new Error("No trials found. Please create a trial first in the Trial Secretary Dashboard.");
                }
                
            } catch (error) {
                console.error("❌ Error setting up secretary view:", error);
                if (error.message.includes('not authenticated')) {
                    // Redirect to login
                    window.location.href = 'index.html';
                } else {
                    throw error;
                }
            }
        }

        // Load specific trial for public entry
        async function loadSpecificTrial(trialId) {
            try {
                console.log("🔍 Loading specific trial:", trialId);
                showStatus('🔄 Loading trial information...', 'info');
                
                const trialDoc = await db.collection('trials').doc(trialId).get();
                
                if (!trialDoc.exists) {
                    throw new Error('Trial not found');
                }

                currentTrialData = { id: trialDoc.id, ...trialDoc.data() };
                console.log("✅ Trial loaded:", currentTrialData.clubName);
                
                // Load saved fee configuration if exists
                if (currentTrialData.feeConfiguration) {
                    const savedFees = currentTrialData.feeConfiguration;
                    fees.regular = savedFees.regularFee || 35.00;
                    fees.feo = savedFees.feoFee || 25.00;
                    fees.juniorHandler = savedFees.juniorHandlerFee || 20.00;
                    console.log("💰 Loaded saved fee configuration:", savedFees);
                }
                
                hideElement('loadingMessage');
                hideElement('trialSelectionSection');
                hideElement('backToDashboard'); // Hide dashboard button for public users
                
                // Show trial info and form
                populateTrialInfo();
                showElement('waiverSection');
                showEntryForm();
                showStatus('✅ Trial loaded successfully!', 'success');
                
            } catch (error) {
                console.error('❌ Error loading specific trial:', error);
                throw new Error('Trial not found or no longer available');
            }
        }

        // Populate trial selector dropdown
        function populateTrialSelector() {
            const trialSelect = document.getElementById('trialSelection');
            trialSelect.innerHTML = '<option value="">Select a trial...</option>';

            availableTrials.forEach(trial => {
                const option = document.createElement('option');
                option.value = trial.id;
                
                let trialLabel = trial.clubName || 'Unnamed Trial';
                
                // Add dates if available
                if (trial.days && trial.days.length > 0) {
                    const dates = trial.days
                        .filter(day => day.date)
                        .map(day => new Date(day.date).toLocaleDateString('en-US', { 
                            month: 'short', 
                            day: 'numeric' 
                        }))
                        .join(', ');
                    if (dates) {
                        trialLabel += ` (${dates})`;
                    }
                }
                
                option.textContent = trialLabel;
                trialSelect.appendChild(option);
            });

            // Handle trial selection change
            trialSelect.addEventListener('change', function(event) {
                const trialId = event.target.value;
                console.log("🎯 Trial selected:", trialId);
                
                if (trialId) {
                    currentTrialData = availableTrials.find(t => t.id === trialId);
                    if (currentTrialData) {
                        console.log("✅ Found trial data:", currentTrialData.clubName);
                        
                        // Load saved fee configuration if exists
                        if (currentTrialData.feeConfiguration) {
                            const savedFees = currentTrialData.feeConfiguration;
                            fees.regular = savedFees.regularFee || 35.00;
                            fees.feo = savedFees.feoFee || 25.00;
                            fees.juniorHandler = savedFees.juniorHandlerFee || 20.00;
                            console.log("💰 Loaded saved fee configuration:", savedFees);
                        }
                        
                        generateShareableLink();
                        populateTrialInfo();
                        showElement('waiverSection');
                        showEntryForm();
                        showStatus('✅ Trial selected successfully!', 'success');
                    } else {
                        console.error("❌ Could not find trial data for ID:", trialId);
                        showStatus('❌ Error loading trial data', 'error');
                    }
                } else {
                    console.log("🚫 No trial selected, hiding sections");
                    hideElement('shareableLinkSection');
                    hideElement('entryFormContainer');
                    hideElement('waiverSection');
                }
            });
        }

        // Generate shareable link
        function generateShareableLink() {
            if (!isSecretary || !currentTrialData) return;

            const baseUrl = window.location.origin + window.location.pathname;
            const shareableUrl = `${baseUrl}?trial=${currentTrialData.id}`;
            
            document.getElementById('shareableUrl').textContent = shareableUrl;
            showElement('shareableLinkSection');
            
            console.log("🔗 Generated shareable link:", shareableUrl);
        }

        // Copy shareable link to clipboard
        function copyShareableLink() {
            const url = document.getElementById('shareableUrl').textContent;
            navigator.clipboard.writeText(url).then(() => {
                showStatus('📋 Link copied to clipboard!', 'success');
            }).catch(err => {
                console.error('Error copying link:', err);
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = url;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showStatus('📋 Link copied to clipboard!', 'success');
            });
        }

        // Test shareable link
        function testShareableLink() {
            const url = document.getElementById('shareableUrl').textContent;
            window.open(url, '_blank');
        }

        // Populate trial information
        function populateTrialInfo() {
            if (!currentTrialData) return;

            document.getElementById('trialTitle').textContent = `${currentTrialData.clubName || 'Trial'} Entry Form`;
            
            console.log("📋 Populating trial info for:", currentTrialData.clubName);
            console.log("📅 Trial data structure:", {
                days: currentTrialData.days?.length || 0,
                firstDay: currentTrialData.days?.[0]
            });
            
            // Generate the tabbed class interface from trial data
            generateTabbedClasses();
        }

        // Show entry form
        function showEntryForm() {
            showElement('entryFormContainer');
        }

        // Generate tabbed classes from trial data
        function generateTabbedClasses() {
            console.log("🎯 Generating tabbed classes from trial data");
            
            if (!currentTrialData.days || currentTrialData.days.length === 0) {
                console.warn("❌ No days data found");
                document.getElementById('classEntriesContainer').innerHTML = 
                    '<div style="text-align: center; padding: 2rem; color: #666;">No classes available for this trial.</div>';
                return;
            }

            console.log(`📅 Processing ${currentTrialData.days.length} days`);

            // Generate day tabs
            const dayTabsContainer = document.getElementById('dayTabs');
            dayTabsContainer.innerHTML = '';

            currentTrialData.days.forEach((day, dayIndex) => {
                const dayDate = day.date 
                    ? new Date(day.date).toLocaleDateString('en-US', { 
                        weekday: 'short', 
                        month: 'short', 
                        day: 'numeric' 
                    })
                    : `Day ${dayIndex + 1}`;

                const tabButton = document.createElement('button');
                tabButton.type = 'button';
                tabButton.className = `day-tab ${dayIndex === 0 ? 'active' : ''}`;
                tabButton.onclick = () => showDay(dayIndex);
                tabButton.textContent = `Day ${dayIndex + 1} - ${dayDate}`;
                
                dayTabsContainer.appendChild(tabButton);
            });

            // Generate class content for each day
            const classEntriesContainer = document.getElementById('classEntriesContainer');
            let html = '';

            currentTrialData.days.forEach((day, dayIndex) => {
                html += `<div class="class-day-content ${dayIndex === 0 ? 'active' : ''}" id="day-${dayIndex}">`;

                if (!day.classes || day.classes.length === 0) {
                    html += '<div style="text-align: center; padding: 2rem; color: #666;">No classes scheduled for this day.</div>';
                } else {
                    console.log(`📋 Day ${dayIndex + 1} has ${day.classes.length} classes`);
                    
                    day.classes.forEach((cls, classIndex) => {
                        const className = cls[STANDARD_FIELDS.CLASS_NAME] || cls.className || 'Unnamed Class';
                        
                        console.log(`🎯 Processing class: ${className} with ${cls.rounds?.length || 0} rounds`);

                        html += `
                            <div class="class-item">
                                <div class="class-header">
                                    <div class="class-name">${className}</div>
                                </div>
                                <div class="rounds-container">
                        `;

                        if (cls.rounds && cls.rounds.length > 0) {
                            cls.rounds.forEach((round, roundIndex) => {
                                const judgeName = round[STANDARD_FIELDS.JUDGE_NAME] || round.judge || 'Judge TBD';
                                const roundName = `Round ${roundIndex + 1}`;
                                
                                // Calculate fees
                                const isJuniorHandler = document.getElementById('juniorHandler')?.value === 'Yes';
                                const regularFee = isJuniorHandler ? fees.juniorHandler : fees.regular;
                                const feoFee = isJuniorHandler ? fees.juniorHandler : fees.feo;
                                
                                html += `
                                    <div class="round-item">
                                        <div class="round-details">
                                            <span class="judge-name">Judge: ${judgeName}</span>
                                            <span>${roundName}</span>
                                        </div>
                                        <div class="entry-options">
                                `;

                                // Show Regular button if fee > 0
                                if (regularFee > 0) {
                                    html += `
                                        <button class="entry-button regular" type="button"
                                                data-class="${className}" 
                                                data-round="${roundName}"
                                                data-judge="${judgeName}"
                                                data-fee="${regularFee.toFixed(2)}" 
                                                data-type="regular"
                                                data-day="${dayIndex}"
                                                data-round-index="${roundIndex}"
                                                onclick="toggleEntry(this)">
                                            Regular ${regularFee.toFixed(2)}
                                        </button>
                                    `;
                                }

                                // Show FEO button if available and fee > 0 and not junior handler
                                if (round.feoAvailable && feoFee > 0 && !isJuniorHandler) {
                                    html += `
                                        <button class="entry-button feo" type="button"
                                                data-class="${className}" 
                                                data-round="${roundName}"
                                                data-judge="${judgeName}"
                                                data-fee="${feoFee.toFixed(2)}" 
                                                data-type="feo"
                                                data-day="${dayIndex}"
                                                data-round-index="${roundIndex}"
                                                onclick="toggleEntry(this)">
                                            FEO ${feoFee.toFixed(2)}
                                        </button>
                                    `;
                                }

                                html += `
                                        </div>
                                    </div>
                                `;
                            });
                        } else {
                            html += '<div style="text-align: center; color: #666; padding: 1rem;">No rounds configured</div>';
                        }

                        html += `
                                </div>
                            </div>
                        `;
                    });
                }

                html += `</div>`;
            });

            classEntriesContainer.innerHTML = html;
            
            console.log("✅ Tabbed classes generated successfully");
            updateEntrySummary();
        }

        // Show specific day tab
        function showDay(dayIndex) {
            // Hide all day content
            document.querySelectorAll('.class-day-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.day-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected day content
            const dayContent = document.getElementById(`day-${dayIndex}`);
            if (dayContent) {
                dayContent.classList.add('active');
            }
            
            // Add active class to selected tab
            const dayTabs = document.querySelectorAll('.day-tab');
            if (dayTabs[dayIndex]) {
                dayTabs[dayIndex].classList.add('active');
            }
        }

        // Toggle entry selection
        function toggleEntry(button) {
            const className = button.dataset.class;
            const roundName = button.dataset.round;
            const judgeName = button.dataset.judge;
            const fee = parseFloat(button.dataset.fee);
            const entryType = button.dataset.type;
            const dayIndex = button.dataset.day;
            const roundIndex = button.dataset.roundIndex;
            
            // Create unique identifier for this entry
            const entryId = `${className}-${roundName}-${dayIndex}-${roundIndex}`;
            
            if (button.classList.contains('selected')) {
                // Remove selection
                button.classList.remove('selected');
                selectedEntries = selectedEntries.filter(entry => 
                    !(entry.entryId === entryId && entry.type === entryType)
                );
                console.log("❌ Removed entry:", entryId, entryType);
            } else {
                // Add selection (but first remove any conflicting entry for same round)
                const conflictingEntries = selectedEntries.filter(entry => 
                    entry.entryId === entryId && entry.type !== entryType
                );
                
                conflictingEntries.forEach(conflictEntry => {
                    // Remove conflicting button selection
                    const conflictButton = document.querySelector(
                        `[data-class="${conflictEntry.className}"][data-round="${conflictEntry.roundName}"][data-type="${conflictEntry.type}"][data-day="${conflictEntry.dayIndex}"][data-round-index="${conflictEntry.roundIndex}"]`
                    );
                    if (conflictButton) {
                        conflictButton.classList.remove('selected');
                    }
                });
                
                // Remove conflicting entries from selectedEntries
                selectedEntries = selectedEntries.filter(entry => entry.entryId !== entryId);
                
                // Add new selection
                button.classList.add('selected');
                selectedEntries.push({
                    entryId: entryId,
                    className: className,
                    roundName: roundName,
                    judgeName: judgeName,
                    fee: fee,
                    type: entryType,
                    dayIndex: dayIndex,
                    roundIndex: roundIndex
                });
                console.log("✅ Added entry:", entryId, entryType, `${fee}`);
            }
            
            updateEntrySummary();
            checkFormValidity();
        }

        // Update entry summary
        function updateEntrySummary() {
            const summaryDiv = document.getElementById('entrySummary');
            const entriesList = document.getElementById('selectedEntriesList');
            const totalFeeSpan = document.getElementById('totalFee');
            const submitSection = document.getElementById('submitSection');
            
            if (selectedEntries.length === 0) {
                summaryDiv.style.display = 'none';
                submitSection.classList.remove('show');
                return;
            }
            
            summaryDiv.style.display = 'block';
            submitSection.classList.add('show');
            
            // Generate entries list
            let html = '';
            selectedEntries.forEach(entry => {
                html += `
                    <li class="selected-entry">
                        Day ${parseInt(entry.dayIndex) + 1}: ${entry.className} - ${entry.roundName} 
                        (${entry.type.toUpperCase()}) - Judge: ${entry.judgeName} - ${entry.fee.toFixed(2)}
                    </li>
                `;
            });
            
            entriesList.innerHTML = html;
            
            // Update total fee
            totalFee = selectedEntries.reduce((sum, entry) => sum + entry.fee, 0);
            totalFeeSpan.textContent = totalFee.toFixed(2);
            
            console.log("💰 Updated summary:", selectedEntries.length, "entries, total:", `${totalFee.toFixed(2)}`);
        }

        // C-WAGS number formatting and lookup
        function formatCwagsNumber(input) {
            // Remove all non-alphanumeric characters
            let cleaned = input.toUpperCase().replace(/[^A-Z0-9]/g, '');
            
            // Format to XX-XXXX-XX pattern
            if (cleaned.length >= 2) {
                let formatted = cleaned.substring(0, 2);
                if (cleaned.length > 2) {
                    formatted += '-' + cleaned.substring(2, 6);
                    if (cleaned.length > 6) {
                        let lastPart = cleaned.substring(6, 8);
                        if (lastPart.length === 1) {
                            lastPart = '0' + lastPart;
                        }
                        formatted += '-' + lastPart;
                    }
                }
                return formatted;
            }
            return cleaned;
        }

        // Show lookup status
        function showLookupStatus(message, type) {
            const statusDiv = document.getElementById('lookupStatus');
            statusDiv.textContent = message;
            statusDiv.className = `status-message status-${type}`;
            statusDiv.style.display = 'block';
        }

        function hideLookupStatus() {
            const statusDiv = document.getElementById('lookupStatus');
            statusDiv.style.display = 'none';
        }

        // Auto-fill from registration data with enhanced fields
        async function autoFillFromRegistration(cwagsNumber) {
            showLookupStatus('🔍 Looking up registration...', 'info');
            
            try {
                console.log("🔍 Looking up registration:", cwagsNumber);
                console.log("📊 Available registrations:", registrationData.length);
                
                // Search in registration data
                const matchingRegistration = registrationData.find(record => {
                    const recordCwag = String(record.cwagsNumber || record.cwag || '').trim();
                    const searchCwag = String(cwagsNumber).trim();
                    
                    return recordCwag === searchCwag || 
                           recordCwag.replace(/-/g, '') === searchCwag.replace(/-/g, '');
                });
                
                if (matchingRegistration) {
                    console.log("✅ Found matching registration:", matchingRegistration);
                    showLookupStatus('✅ Registration found! Auto-filling information...', 'success');
                    populateForm(matchingRegistration);
                } else {
                    console.log("❌ No matching registration found for:", cwagsNumber);
                    showLookupStatus('ℹ️ Registration number not found. Information will be saved when you submit.', 'warning');
                }
                
            } catch (error) {
                console.error("❌ Error during registration lookup:", error);
                showLookupStatus('❌ Error looking up registration', 'error');
            }
        }

        // Populate form with comprehensive registration data
        function populateForm(registration) {
            console.log("📝 Populating form with registration data:", registration);
            
            // Handler information
            if (registration.handlerName || registration.handler) {
                const handlerField = document.getElementById('handlerName');
                handlerField.value = registration.handlerName || registration.handler;
                handlerField.style.background = '#e7f3ff';
                setTimeout(() => handlerField.style.background = '', 3000);
            }
            
            if (registration.handlerPhone) {
                const phoneField = document.getElementById('handlerPhone');
                phoneField.value = registration.handlerPhone;
                phoneField.style.background = '#e7f3ff';
                setTimeout(() => phoneField.style.background = '', 3000);
            }
            
            if (registration.handlerEmail) {
                const emailField = document.getElementById('handlerEmail');
                emailField.value = registration.handlerEmail;
                emailField.style.background = '#e7f3ff';
                setTimeout(() => emailField.style.background = '', 3000);
            }
            
            if (registration.emergencyContact) {
                const emergencyField = document.getElementById('emergencyContact');
                emergencyField.value = registration.emergencyContact;
                emergencyField.style.background = '#e7f3ff';
                setTimeout(() => emergencyField.style.background = '', 3000);
            }
            
            // Dog information
            if (registration.dogCallName || registration.dog) {
                const dogField = document.getElementById('dogCallName');
                dogField.value = registration.dogCallName || registration.dog;
                dogField.style.background = '#e7f3ff';
                setTimeout(() => dogField.style.background = '', 3000);
            }
            
            if (registration.dogBreed) {
                const breedField = document.getElementById('dogBreed');
                breedField.value = registration.dogBreed;
                breedField.style.background = '#e7f3ff';
                setTimeout(() => breedField.style.background = '', 3000);
            }
            
            if (registration.dogBirthdate) {
                const birthdateField = document.getElementById('dogBirthdate');
                birthdateField.value = registration.dogBirthdate;
                birthdateField.style.background = '#e7f3ff';
                setTimeout(() => birthdateField.style.background = '', 3000);
            }
            
            if (registration.dogSex) {
                const sexField = document.getElementById('dogSex');
                sexField.value = registration.dogSex;
                sexField.style.background = '#e7f3ff';
                setTimeout(() => sexField.style.background = '', 3000);
            }
            
            if (registration.juniorHandler !== undefined) {
                const juniorField = document.getElementById('juniorHandler');
                juniorField.value = registration.juniorHandler ? 'Yes' : 'No';
                juniorField.style.background = '#e7f3ff';
                setTimeout(() => juniorField.style.background = '', 3000);
            }
        }

        // Save or update registration data
        async function saveOrUpdateRegistration(entryData) {
            try {
                const cwagsNumber = entryData[STANDARD_FIELDS.CWAGS_NUMBER];
                
                if (!cwagsNumber) {
                    console.log("📝 No C-WAGS number provided, skipping registration save");
                    return null;
                }
                
                console.log("💾 Saving/updating registration for:", cwagsNumber);
                
                // Check if registration already exists
                const existingRegQuery = await db.collection('registrations')
                    .where('cwagsNumber', '==', cwagsNumber)
                    .get();
                
                const registrationData = {
                    cwagsNumber: cwagsNumber,
                    handlerName: entryData[STANDARD_FIELDS.HANDLER_NAME],
                    handlerPhone: entryData.handlerPhone || '',
                    handlerEmail: entryData.handlerEmail || '',
                    emergencyContact: entryData.emergencyContact || '',
                    dogCallName: entryData[STANDARD_FIELDS.DOG_CALL_NAME],
                    dogBreed: entryData.dogBreed || '',
                    dogBirthdate: entryData.dogBirthdate || '',
                    dogSex: entryData.dogSex || '',
                    juniorHandler: entryData.juniorHandler || false,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                    lastTrialEntry: entryData.trialId
                };
                
                let registrationId;
                
                if (!existingRegQuery.empty) {
                    // Update existing registration
                    const existingDoc = existingRegQuery.docs[0];
                    registrationId = existingDoc.id;
                    
                    await db.collection('registrations').doc(registrationId).update(registrationData);
                    console.log("✅ Updated existing registration:", registrationId);
                } else {
                    // Create new registration
                    registrationData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    
                    const docRef = await db.collection('registrations').add(registrationData);
                    registrationId = docRef.id;
                    console.log("✅ Created new registration:", registrationId);
                }
                
                // Update local registry for future lookups in this session
                const existingIndex = registrationData.findIndex(reg => 
                    reg.cwagsNumber === cwagsNumber || reg.cwag === cwagsNumber
                );
                
                if (existingIndex >= 0) {
                    registrationData[existingIndex] = { id: registrationId, ...registrationData };
                } else {
                    registrationData.push({ id: registrationId, ...registrationData });
                }
                
                return registrationId;
                
            } catch (error) {
                console.error("❌ Error saving registration:", error);
                showStatus('⚠️ Could not save registration data, but entry was submitted', 'warning');
                return null;
            }
        }

        // Setup form event listeners
        function setupFormEventListeners() {
            // C-WAGS number formatting and lookup
            const cwagsInput = document.getElementById('cwagsNumber');
            if (cwagsInput) {
                cwagsInput.addEventListener('input', function(e) {
                    const formatted = formatCwagsNumber(e.target.value);
                    e.target.value = formatted;
                    
                    // Clear any existing timeout
                    if (window.cwagsTimeout) {
                        clearTimeout(window.cwagsTimeout);
                    }
                    
                    if (formatted.length >= 8) { // Minimum length for lookup
                        window.cwagsTimeout = setTimeout(() => {
                            autoFillFromRegistration(formatted);
                        }, 500);
                    } else {
                        hideLookupStatus();
                    }
                    
                    checkFormValidity();
                });
            }

            // Form validation listeners
            ['handlerName', 'dogCallName', 'waiverAccepted'].forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', checkFormValidity);
                    field.addEventListener('change', checkFormValidity);
                }
            });

            // Junior handler change affects fees
            const juniorSelect = document.getElementById('juniorHandler');
            if (juniorSelect) {
                juniorSelect.addEventListener('change', function() {
                    if (currentTrialData) {
                        generateTabbedClasses();
                    }
                    updateEntrySummary();
                });
            }

            // Submit button
            const submitBtn = document.getElementById('submitEntry');
            if (submitBtn) {
                submitBtn.addEventListener('click', submitEntry);
            }
        }

        // Check form validity
        function checkFormValidity() {
            const waiverAccepted = document.getElementById('waiverAccepted')?.checked;
            const handlerName = document.getElementById('handlerName')?.value.trim();
            const dogCallName = document.getElementById('dogCallName')?.value.trim();
            const hasClasses = selectedEntries.length > 0;
            
            const isValid = waiverAccepted && handlerName && dogCallName && hasClasses;
            
            const submitBtn = document.getElementById('submitEntry');
            if (submitBtn) {
                submitBtn.disabled = !isValid;
            }
            
            return isValid;
        }

        // Submit entry with registration saving
        async function submitEntry() {
            console.log("🚀 Starting entry submission...");
            
            if (!checkFormValidity()) {
                showStatus('Please complete all required fields and select at least one class.', 'error');
                return;
            }
            
            const submitBtn = document.getElementById('submitEntry');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';
            
            try {
                // Collect form data
                const entryData = {
                    trialId: currentTrialData.id,
                    trialName: currentTrialData.clubName,
                    [STANDARD_FIELDS.HANDLER_NAME]: document.getElementById('handlerName').value.trim(),
                    handlerEmail: document.getElementById('handlerEmail').value.trim(),
                    handlerPhone: document.getElementById('handlerPhone').value.trim(),
                    emergencyContact: document.getElementById('emergencyContact').value.trim(),
                    [STANDARD_FIELDS.DOG_CALL_NAME]: document.getElementById('dogCallName').value.trim(),
                    dogBreed: document.getElementById('dogBreed').value.trim(),
                    dogBirthdate: document.getElementById('dogBirthdate').value,
                    dogSex: document.getElementById('dogSex').value,
                    [STANDARD_FIELDS.CWAGS_NUMBER]: document.getElementById('cwagsNumber').value.trim(),
                    juniorHandler: document.getElementById('juniorHandler').value === 'Yes',
                    selectedEntries: selectedEntries,
                    totalFee: totalFee,
                    submittedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    waiverAccepted: true
                };
                
                console.log("📝 Entry data prepared:", entryData);
                
                // Save/update registration data first (if C-WAGS number provided)
                let registrationId = null;
                if (entryData[STANDARD_FIELDS.CWAGS_NUMBER]) {
                    registrationId = await saveOrUpdateRegistration(entryData);
                    if (registrationId) {
                        entryData.registrationId = registrationId;
                        console.log("✅ Registration saved/updated:", registrationId);
                    }
                }
                
                // Save trial entry to Firebase
                const docRef = await db.collection("entries").add(entryData);
                console.log("✅ Entry saved with ID:", docRef.id);
                
                // Show success message
                document.getElementById('entryForm').style.display = 'none';
                document.getElementById('successMessage').style.display = 'block';
                
                // Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
                
                showStatus('✅ Entry submitted successfully! Registration information saved for future use.', 'success');
                
            } catch (error) {
                console.error("❌ Error submitting entry:", error);
                showStatus("Error submitting entry: " + error.message, 'error');
                
                // Reset button
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }

        // Reset form for another entry
        function resetForm() {
            // Reset form fields
            document.getElementById('entryForm').reset();
            
            // Clear selected entries
            selectedEntries = [];
            totalFee = 0;
            
            // Clear all selected buttons
            document.querySelectorAll('.entry-button.selected').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Update display
            updateEntrySummary();
            checkFormValidity();
            
            // Hide success message and show form
            document.getElementById('successMessage').style.display = 'none';
            document.getElementById('entryForm').style.display = 'block';
            
            // Clear lookup status
            hideLookupStatus();
            
            console.log("📝 Form reset for new entry");
            showStatus('Form reset for new entry', 'info');
        }

        // Make functions globally accessible
        window.showDay = showDay;
        window.toggleEntry = toggleEntry;
        window.copyShareableLink = copyShareableLink;
        window.testShareableLink = testShareableLink;
        window.resetForm = resetForm;

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log("🎯 DOM loaded, initializing entry form...");
            init();
        });

        console.log("🎯 Fixed Trial Entry Form script loaded successfully");
    </script>
</body>
</html>
