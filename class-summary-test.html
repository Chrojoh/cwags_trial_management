<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Summary - Syntax Test</title>
    
    <!-- Firebase SDKs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-auth-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-firestore-compat.min.js"></script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        select {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            display: none;
        }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Class Summary - Syntax Test</h1>
        <p>Testing basic trial loading functionality</p>
        
        <div class="status" id="statusMessage"></div>
        
        <label for="trialSelect">Select Trial:</label>
        <select id="trialSelect">
            <option value="">Loading trials...</option>
        </select>
        
        <label for="classSelect">Select Class:</label>
        <select id="classSelect">
            <option value="">Select a trial first</option>
        </select>
        
        <div id="debugOutput" style="margin-top: 20px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
            <strong>Debug Output:</strong>
            <div id="debugContent">Waiting for initialization...</div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBWpyM_lEpqdQWuKuLLZiW1SlloWsWkJCs",
            authDomain: "dog-trialing-system.firebaseapp.com",
            projectId: "dog-trialing-system",
            storageBucket: "dog-trialing-system.firebasestorage.app",
            messagingSenderId: "490812593982",
            appId: "1:490812593982:web:344776707566f8d9027e6f",
            measurementId: "G-EMLX58Y278"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Global variables
        let currentUser = null;
        let currentTrial = null;

        // Utility functions
        function showStatus(message, type = 'info') {
            console.log(`[${type.toUpperCase()}] ${message}`);
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        function updateDebug(content) {
            document.getElementById('debugContent').innerHTML = content;
        }

        function createLocalDate(dateStr) {
            if (!dateStr) return null;
            if (typeof dateStr === 'string') {
                const dateWithTime = dateStr.includes('T') ? dateStr : dateStr + 'T12:00:00';
                return new Date(dateWithTime);
            }
            return new Date(dateStr);
        }

        // Initialize the application
        async function init() {
            try {
                console.log('üîß Starting initialization...');
                updateDebug('üîß Starting initialization...');
                
                await new Promise((resolve, reject) => {
                    const unsubscribe = auth.onAuthStateChanged(async (user) => {
                        unsubscribe();
                        if (user) {
                            try {
                                console.log('üë§ User authenticated:', user.uid);
                                updateDebug(`üë§ User authenticated: ${user.uid}`);
                                
                                const userDoc = await db.collection('users').doc(user.uid).get();
                                if (userDoc.exists) {
                                    currentUser = { uid: user.uid, ...userDoc.data() };
                                    console.log('‚úÖ User profile loaded:', currentUser.firstName, currentUser.lastName);
                                    updateDebug(`‚úÖ User profile loaded: ${currentUser.firstName || 'N/A'} ${currentUser.lastName || 'N/A'}`);
                                    resolve();
                                } else {
                                    reject(new Error('User profile not found'));
                                }
                            } catch (error) {
                                console.error('‚ùå Error loading user profile:', error);
                                updateDebug(`‚ùå Error loading user profile: ${error.message}`);
                                reject(error);
                            }
                        } else {
                            console.log('‚ùå No user authenticated, redirecting to login');
                            updateDebug('‚ùå No user authenticated, redirecting to login');
                            window.location.href = 'index.html';
                        }
                    });
                });

                console.log('üìã Loading trials for user...');
                updateDebug('üìã Loading trials for user...');
                await loadTrials();
                
                console.log('‚úÖ Initialization complete');
                updateDebug('‚úÖ Initialization complete');
                
            } catch (error) {
                console.error('‚ùå Error initializing:', error);
                updateDebug(`‚ùå Error initializing: ${error.message}`);
                showStatus('Error initializing application: ' + error.message, 'error');
            }
        }

        // Load trials for the dropdown
        async function loadTrials() {
            try {
                console.log('üìä Starting trial load process...');
                showStatus('Loading your trials...', 'info');
                updateDebug('üìä Starting trial load process...');

                if (!currentUser || !currentUser.uid) {
                    throw new Error('No authenticated user found');
                }

                console.log('üîç Querying trials for user:', currentUser.uid);
                updateDebug(`üîç Querying trials for user: ${currentUser.uid}`);
                
                const trialsSnapshot = await db.collection("trials")
                    .where("createdBy", "==", currentUser.uid)
                    .get();

                console.log(`üìà Found ${trialsSnapshot.size} trials in database`);
                updateDebug(`üìà Found ${trialsSnapshot.size} trials in database`);

                const trialSelect = document.getElementById('trialSelect');
                if (!trialSelect) {
                    throw new Error('Trial select element not found');
                }

                trialSelect.innerHTML = '<option value="">Select a trial...</option>';

                if (!trialsSnapshot.empty) {
                    const trials = [];
                    trialsSnapshot.forEach(doc => {
                        const trialData = doc.data();
                        console.log(`üìã Processing trial: ${trialData.clubName || 'Unnamed'} (${doc.id})`);
                        trials.push({ id: doc.id, ...trialData });
                    });

                    // Sort trials by creation date
                    trials.sort((a, b) => {
                        const aTime = a.createdAt ? a.createdAt.seconds : 0;
                        const bTime = b.createdAt ? b.createdAt.seconds : 0;
                        return bTime - aTime;
                    });

                    trials.forEach(trial => {
                        const option = document.createElement('option');
                        option.value = trial.id;
                        
                        let trialLabel = trial.clubName || 'Unnamed Trial';
                        
                        // Add dates if available
                        if (trial.days && trial.days.length > 0) {
                            const dates = trial.days
                                .filter(day => day.date)
                                .map(day => {
                                    const localDate = createLocalDate(day.date);
                                    return localDate.toLocaleDateString('en-US', { 
                                        month: 'short', 
                                        day: 'numeric',
                                        timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
                                    });
                                })
                                .join(', ');
                            if (dates) {
                                trialLabel += ` (${dates})`;
                            }
                        }
                        
                        option.textContent = trialLabel;
                        trialSelect.appendChild(option);
                        console.log(`‚úÖ Added trial option: ${trialLabel}`);
                    });

                    showStatus(`Found ${trials.length} trials`, 'success');
                    updateDebug(`‚úÖ Successfully loaded ${trials.length} trials into dropdown:<br>${trials.map(t => `‚Ä¢ ${t.clubName || 'Unnamed'}`).join('<br>')}`);
                    
                    console.log(`‚úÖ Successfully loaded ${trials.length} trials into dropdown`);
                } else {
                    console.log('‚ö†Ô∏è No trials found for this user');
                    updateDebug('‚ö†Ô∏è No trials found for this user');
                    showStatus('No trials found', 'error');
                    trialSelect.innerHTML = '<option value="">No trials found - create a trial first</option>';
                }
            } catch (error) {
                console.error('‚ùå Error loading trials:', error);
                updateDebug(`‚ùå Error loading trials: ${error.message}`);
                showStatus('Error loading trials: ' + error.message, 'error');
                
                const trialSelect = document.getElementById('trialSelect');
                if (trialSelect) {
                    trialSelect.innerHTML = '<option value="">Error loading trials</option>';
                }
            }
        }

        // Load classes when trial is selected
        async function loadTrialClasses() {
            const trialId = document.getElementById('trialSelect').value;
            const classSelect = document.getElementById('classSelect');
            
            if (!trialId) {
                classSelect.innerHTML = '<option value="">Select a trial first</option>';
                updateDebug('No trial selected');
                return;
            }

            try {
                showStatus('Loading trial classes...', 'info');
                updateDebug(`Loading classes for trial: ${trialId}`);

                const trialDoc = await db.collection('trials').doc(trialId).get();
                if (!trialDoc.exists) {
                    throw new Error('Trial not found');
                }

                currentTrial = { id: trialDoc.id, ...trialDoc.data() };
                console.log('‚úÖ Trial loaded:', currentTrial.clubName);

                const classNames = new Set();
                
                if (currentTrial.days && Array.isArray(currentTrial.days)) {
                    currentTrial.days.forEach(day => {
                        if (day.classes && Array.isArray(day.classes)) {
                            day.classes.forEach(cls => {
                                const className = cls.className || cls.class || cls.CLASS_NAME;
                                if (className) {
                                    classNames.add(className.trim());
                                }
                            });
                        }
                    });
                }

                classSelect.innerHTML = '<option value="">Select a class...</option>';
                
                if (classNames.size > 0) {
                    const sortedClasses = Array.from(classNames).sort();
                    
                    sortedClasses.forEach(className => {
                        const option = document.createElement('option');
                        option.value = className;
                        option.textContent = className;
                        classSelect.appendChild(option);
                    });
                    
                    showStatus(`Found ${classNames.size} classes`, 'success');
                    updateDebug(`‚úÖ Found ${classNames.size} classes:<br>${sortedClasses.map(c => `‚Ä¢ ${c}`).join('<br>')}`);
                } else {
                    showStatus('No classes found in this trial', 'error');
                    updateDebug('‚ö†Ô∏è No classes found in this trial');
                }

            } catch (error) {
                console.error('Error loading trial classes:', error);
                updateDebug(`‚ùå Error loading classes: ${error.message}`);
                showStatus('Error loading classes: ' + error.message, 'error');
            }
        }

        // Add event listener for trial selection
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, starting test...');
            
            // Add event listener for trial selection
            document.getElementById('trialSelect').addEventListener('change', loadTrialClasses);
            
            // Initialize
            init();
        });

        console.log('Minimal class summary test loaded successfully');
    </script>
</body>
</html>
