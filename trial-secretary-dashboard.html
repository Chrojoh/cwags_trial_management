<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trial Secretary Dashboard</title>
    
    <!-- Firebase SDKs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-auth-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-firestore-compat.min.js"></script>
    
    <!-- SheetJS for Excel processing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 1.5rem;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn {
            padding: 0.8rem 1.5rem;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            margin: 0.25rem;
        }

        .btn:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .status-message {
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 8px;
            display: none;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-info {
            background: #cce7ff;
            color: #0056b3;
            border: 1px solid #99d3ff;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            color: #333;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        input[type="text"],
        input[type="date"],
        input[type="number"],
        select {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .day-container {
            border: 1px solid #ccc;
            padding: 15px;
            margin: 10px 0;
            background-color: #f9f9f9;
            border-radius: 8px;
        }
        
        .class-container {
            border: 1px solid #ddd;
            padding: 10px;
            margin: 5px 0;
            background-color: #fff;
            border-radius: 6px;
        }
        
        .round-container {
            padding: 8px;
            margin: 3px 0;
            background-color: #f0f0f0;
            border-radius: 4px;
        }

        .subclass-container {
            padding: 8px;
            margin: 3px 0;
            background-color: #f0fff0;
            border-radius: 4px;
            border-left: 3px solid #28a745;
        }

        .hidden {
            display: none;
        }

        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .excel-upload {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            margin: 1rem 0;
            transition: all 0.3s ease;
        }

        .excel-upload:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .trials-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .trial-item {
            padding: 1rem;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 1rem;
            background: #f8f9fa;
        }

        /* Delete confirmation modal styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .modal-content h3 {
            color: #dc3545;
            margin-bottom: 1rem;
        }

        .modal-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1.5rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div>
                <h1>üèÜ Trial Secretary Dashboard</h1>
                <div id="userInfo">Loading...</div>
            </div>
            <div>
                <button class="btn btn-secondary" onclick="window.location.href='create-trial.html'">Create Trial (Full)</button>
                <button class="btn btn-secondary" onclick="window.location.href='index.html'">Logout</button>
                <button class="btn" onclick="window.location.href='trial-entry-form.html'"> üìù Create Entry Form </button>
                <button class="btn" onclick="window.location.href='registry-migration.html'"> üìä Migrate Excel to Registry</button>
                 <button class="btn" onclick="window.location.href='running-order.html'">üìä Running Order</button>
                <button class="btn" onclick="window.location.href='entry-management.html'">üìù Manage Entries</button>
            </div>
        </div>

        <!-- Status Message -->
        <div class="status-message" id="statusMessage"></div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Create Trial Form -->
            <div class="card">
                <h2>üìã Create New Trial</h2>
                
                <form id="trialForm" onsubmit="return submitTrial(event)">
                    <div class="form-group">
                        <label for="clubName">Club Name</label>
                        <input type="text" id="clubName" required onkeydown="handleEnterKey(event)">
                    </div>

                    <div class="form-group">
                        <label for="secretary">Trial Secretary</label>
                        <input type="text" id="secretary" required onkeydown="handleEnterKey(event)">
                    </div>

                    <div class="form-group">
                        <label for="numDays">How many days?</label>
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <input type="number" id="numDays" min="1" max="10" style="width: 100px;" onkeydown="handleEnterKey(event)" onfocus="this.select()">
                            <button type="button" class="btn btn-secondary" onclick="generateDays()" onkeydown="return false;">Create Days</button>
                        </div>
                    </div>
                    
                    <div id="daysContainer"></div>
                    
                    <button type="submit" class="btn btn-success" style="width: 100%; padding: 1rem; margin-top: 2rem;">
                        üèÜ Save Trial
                    </button>
                </form>
            </div>

            <!-- My Trials -->
            <div class="card">
                <h2>üìÖ My Trials</h2>
                <div class="trials-list" id="trialsList">
                    <p style="color: #666; text-align: center; padding: 2rem;">No trials created yet.</p>
                </div>
                <button class="btn" onclick="refreshTrials()">üîÑ Refresh</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal-content">
            <h3>üóëÔ∏è Delete Trial</h3>
            <p>Are you sure you want to delete this trial?</p>
            <p><strong id="deleteTrialName"></strong></p>
            <p style="color: #dc3545; font-size: 0.9rem; margin-top: 0.5rem;">This action cannot be undone.</p>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="cancelDelete()">Cancel</button>
                <button class="btn btn-danger" onclick="confirmDelete()">Delete Trial</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBWpyM_lEpqdQWuKuLLZiW1SlloWsWkJCs",
            authDomain: "dog-trialing-system.firebaseapp.com",
            projectId: "dog-trialing-system",
            storageBucket: "dog-trialing-system.firebasestorage.app",
            messagingSenderId: "490812593982",
            appId: "1:490812593982:web:344776707566f8d9027e6f",
            measurementId: "G-EMLX58Y278"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Global variables
        let currentUser = null;
        let globalClasses = [];
        let globalJudges = [];
        let cwagsNumbers = [];
        let dogNames = [];
        let authInitialized = false;
        let dashboardInitialized = false;
        let trialToDelete = null;

        // Utility functions
        function showStatus(message, isError = false) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = 'status-message ' + (isError ? 'status-error' : 'status-success');
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        // Standard field names
        const STANDARD_FIELDS = {
            HANDLER_NAME: 'handlerName',
            DOG_CALL_NAME: 'dogCallName',
            JUDGE_NAME: 'judgeName',
            CLASS_NAME: 'className',
            CWAGS_NUMBER: 'cwagsNumber'
        };

        // Handle Enter key navigation
        function handleEnterKey(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                event.stopPropagation();
                
                if (event.target.tagName === 'BUTTON' || event.target.type === 'button') {
                    return false;
                }
                
                const inputs = Array.from(document.querySelectorAll('input[type="text"], input[type="number"], input[type="date"], select'));
                const currentIndex = inputs.indexOf(event.target);
                
                if (currentIndex !== -1 && currentIndex < inputs.length - 1) {
                    inputs[currentIndex + 1].focus();
                }
                
                return false;
            }
        }

        // Prevent Enter key from triggering buttons
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                if (event.target.tagName === 'BUTTON' || event.target.type === 'button') {
                    event.preventDefault();
                    event.stopPropagation();
                    return false;
                }
                
                if (event.target.form && event.target.type !== 'submit') {
                    event.preventDefault();
                    event.stopPropagation();
                    handleEnterKey(event);
                    return false;
                }
            }
        });
        
        // Process Excel data using SheetJS
        function processExcelData(data) {
            const workbook = XLSX.read(data, {type: 'array', cellDates: true});
            const dataSheet = workbook.Sheets['Data'] || workbook.Sheets[workbook.SheetNames[0]];
            
            if (!dataSheet) {
                console.error('No data sheet found');
                return null;
            }
            
            const jsonData = XLSX.utils.sheet_to_json(dataSheet, {
                header: 1, 
                dateNF: 'yyyy-mm-dd',
                defval: ''
            });
            
            return jsonData;
        }

        // Load data automatically
        async function loadDataAutomatically() {
            if (!currentUser) {
                console.log('No current user, skipping data load...');
                return false;
            }
            
            try {
                showStatus('üîç Checking for saved data...', false);
                
                const dataDoc = await db.collection('system_data').doc('dataforsite').get();
                if (dataDoc.exists) {
                    const data = dataDoc.data();
                    globalClasses = data.classes || [];
                    globalJudges = data.judges || [];
                    cwagsNumbers = data.cwagsNumbers || [];
                    dogNames = data.dogNames || [];
                    
                    if (globalClasses.length > 0) {
                        updateDataStatus();
                        console.log('Data loaded from Firebase successfully');
                        return true;
                    }
                }
                
                showStatus('üîÑ Looking for dataforsite.xlsx...', false);
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    controller.abort();
                }, 2000);
                
                try {
                    const response = await fetch('./dataforsite.xlsx', {
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (response.ok) {
                        const arrayBuffer = await response.arrayBuffer();
                        const data = new Uint8Array(arrayBuffer);
                        const jsonData = processExcelData(data);
                        
                        if (jsonData && jsonData.length > 0) {
                            await extractDataFromExcel(jsonData);
                            showStatus(`‚úÖ Auto-loaded dataforsite.xlsx! Found ${globalClasses.length} classes, ${globalJudges.length} judges`);
                            console.log('Data loaded from file successfully');
                            return true;
                        }
                    }
                } catch (fetchError) {
                    clearTimeout(timeoutId);
                    console.log('File fetch failed:', fetchError.message);
                }
                
                showStatus('üìÅ Please upload dataforsite.xlsx manually', false);
                return false;
                
            } catch (error) {
                console.error('Error in loadDataAutomatically:', error);
                showStatus('üìÅ Please upload dataforsite.xlsx manually', false);
                return false;
            }
        }

        // Update data status display
        function updateDataStatus() {
            showStatus(`‚úÖ Data Ready: ${cwagsNumbers.length} registrations, ${globalClasses.length} classes, ${globalJudges.length} judges`, false);
        }

        // Generate days
        function generateDays() {
            const numDays = parseInt(document.getElementById('numDays').value);
            if (!numDays || numDays < 1) {
                alert("Please enter a valid number of days");
                return;
            }
            
            const container = document.getElementById('daysContainer');
            container.innerHTML = "";
            
            for (let d = 0; d < numDays; d++) {
                const dayDiv = document.createElement("div");
                dayDiv.className = "day-container";
                dayDiv.innerHTML = `
                    <h3>Day ${d + 1}</h3>
                    <label>Date:</label>
                    <input type="date" name="date${d}" style="margin-left: 10px; margin-bottom: 10px;">
                    
                    <label style="display: block; margin: 10px 0;">How many classes for Day ${d + 1}?</label>
                    <input type="number" id="numClasses_${d}" min="1" max="20" style="width: 100px; padding: 5px;">
                    <button type="button" onclick="generateClasses(${d})">Create Classes</button>
                    
                    <div class="classes-container-${d}"></div>
                `;
                container.appendChild(dayDiv);
            }
        }

        // Generate classes
        function generateClasses(dayIndex) {
            const numClasses = parseInt(document.getElementById(`numClasses_${dayIndex}`).value);
            if (!numClasses || numClasses < 1) {
                alert("Please enter a valid number of classes");
                return;
            }
            
            const container = document.querySelector(`.classes-container-${dayIndex}`);
            container.innerHTML = "";
            
            for (let c = 0; c < numClasses; c++) {
                const classDiv = document.createElement("div");
                classDiv.className = "class-container";
                classDiv.innerHTML = `
                    <h4>Class ${c + 1}</h4>
                    <label>Class Name:</label>
                    <input type="text" 
                           style="margin-left: 10px; width: 250px; padding: 8px;" 
                           placeholder="Type class name..." 
                           list="classes-datalist-${dayIndex}-${c}"
                           class="class-autocomplete"
                           onchange="handleClassSelection(${dayIndex}, ${c}, this.value)">
                    <datalist id="classes-datalist-${dayIndex}-${c}">
                        ${globalClasses.map(name => `<option value="${name}">${name}</option>`).join('')}
                    </datalist>
                    
                    <div id="subclass-container-${dayIndex}-${c}" class="subclass-container hidden">
                        <label style="display: block; margin: 10px 0;">Sub Class:</label>
                        <select id="subclass_${dayIndex}_${c}" style="width: 200px; padding: 5px;">
                            <option value="">Select Sub Class</option>
                        </select>
                    </div>
                    
                    <label style="display: block; margin: 10px 0;">How many rounds for Class ${c + 1}?</label>
                    <input type="number" id="numRounds_${dayIndex}_${c}" min="1" max="10" style="width: 100px; padding: 5px;">
                    <button type="button" onclick="generateRounds(${dayIndex}, ${c})">Create Rounds</button>
                    
                    <div class="rounds-container-${dayIndex}-${c}"></div>
                `;
                container.appendChild(classDiv);
            }
        }

        // Handle class selection for sub-classes
        function handleClassSelection(dayIndex, classIndex, className) {
            const subclassContainer = document.getElementById(`subclass-container-${dayIndex}-${classIndex}`);
            const subclassSelect = document.getElementById(`subclass_${dayIndex}_${classIndex}`);
            
            if (className.toLowerCase().includes('games')) {
                subclassSelect.innerHTML = `
                    <option value="">Select Games Sub Class</option>
                    <option value="games1">Games Sub Class 1</option>
                    <option value="games2">Games Sub Class 2</option>
                    <option value="games3">Games Sub Class 3</option>
                    <option value="games4">Games Sub Class 4</option>
                    <option value="games5">Games Sub Class 5</option>
                `;
                subclassContainer.classList.remove('hidden');
            } else if (className.toLowerCase().includes('obedience') || className.toLowerCase
